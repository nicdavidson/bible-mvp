<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Free, open-source Bible study platform with cross-resource linking">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="In the Word">
    <title>In the Word - Free Bible Study Tool</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/static/icons/icon.svg">
    <link rel="apple-touch-icon" href="/static/icons/icon.svg">
    <link rel="stylesheet" href="/static/css/style.css">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="bibleApp()" x-init="init()" :class="{ 'dark': darkMode }">
    <!-- Toast notification for caching feedback -->
    <div id="cache-toast" class="cache-toast" style="display: none;">
        <span class="toast-icon">&#10003;</span>
        <span class="toast-message"></span>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1 class="logo"><span class="logo-icon">üìñ</span><span class="logo-text">In the Word</span></h1>
        </div>
        <div class="header-center">
            <div class="reference-input">
                <button @click="toggleBookPicker" class="btn-picker" title="Browse books">
                    <span class="picker-icon">‚ò∞</span>
                </button>
                <div class="autocomplete-wrapper">
                    <input
                        type="text"
                        x-model="referenceInput"
                        x-ref="referenceInput"
                        @input="updateSuggestions"
                        @keydown="handleInputKeydown"
                        @blur="hideSuggestions"
                        @focus="updateSuggestions"
                        placeholder="Enter reference (e.g., John 3:16)"
                        class="input-reference"
                        autocomplete="off"
                    >
                    <ul class="autocomplete-dropdown" x-show="showSuggestions" x-transition>
                        <template x-for="(book, index) in bookSuggestions" :key="book">
                            <li
                                @mousedown.prevent="selectSuggestion(book)"
                                :class="{ 'selected': index === selectedSuggestionIndex }"
                                class="autocomplete-item"
                                x-text="book"
                            ></li>
                        </template>
                    </ul>
                </div>
                <select x-model="translation" class="select-translation" title="Bible Translation">
                    <option value="BSB">BSB - Berean Standard</option>
                    <option value="WEB">WEB - World English</option>
                    <option value="KJV">KJV - King James</option>
                </select>
                <button @click="loadPassage" class="btn-go">Go</button>
            </div>

            <!-- Book Picker Dropdown -->
            <div class="book-picker-dropdown" x-show="showBookPicker" x-transition @click.outside="showBookPicker = false">
                <div class="picker-content">
                    <!-- Translation selector (mobile only - shown via CSS) -->
                    <div class="picker-translation-mobile">
                        <label>Translation:</label>
                        <select x-model="translation" class="picker-translation-select">
                            <option value="BSB">BSB - Berean Standard Bible</option>
                            <option value="WEB">WEB - World English Bible</option>
                            <option value="KJV">KJV - King James Version</option>
                        </select>
                    </div>
                    <!-- Book selection -->
                    <div class="picker-books" x-show="!pickerSelectedBook">
                        <div class="picker-section">
                            <h4>Old Testament</h4>
                            <div class="picker-book-grid">
                                <template x-for="book in otBooks" :key="book">
                                    <button @click="selectPickerBook(book)" class="picker-book-btn" x-text="book"></button>
                                </template>
                            </div>
                        </div>
                        <div class="picker-section">
                            <h4>New Testament</h4>
                            <div class="picker-book-grid">
                                <template x-for="book in ntBooks" :key="book">
                                    <button @click="selectPickerBook(book)" class="picker-book-btn" x-text="book"></button>
                                </template>
                            </div>
                        </div>
                    </div>
                    <!-- Chapter selection -->
                    <div class="picker-chapters" x-show="pickerSelectedBook">
                        <div class="picker-header">
                            <button @click="pickerSelectedBook = null" class="picker-back-btn">‚Üê Back</button>
                            <span class="picker-book-title" x-text="pickerSelectedBook"></span>
                        </div>
                        <div class="picker-chapter-grid">
                            <template x-for="ch in getChaptersArray(pickerSelectedBook)" :key="ch">
                                <button @click="selectPickerChapter(ch)" class="picker-chapter-btn" x-text="ch"></button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="offline-indicator" :class="isOnline ? 'online' : 'offline'" @click="openSettings('offline')" :title="isOnline ? 'Online' : 'Offline - using cached data'">
                <span class="status-dot"></span>
                <span class="offline-label" x-text="isOnline ? '' : 'Offline'"></span>
            </div>
            <button @click="openSearch()" class="btn-icon" title="Search (/)">
                üîç
            </button>
            <button @click="openSettings()" class="btn-icon" title="Settings">
                ‚öôÔ∏è
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Bible Text Panel -->
        <section class="panel panel-text">
            <div class="panel-header">
                <h2 x-text="currentReference || 'Select a passage'"></h2>
                <div class="header-controls" x-show="currentReference">
                    <label class="interlinear-toggle-header" x-show="otBooks.includes(currentBook) || ntBooks.includes(currentBook)" title="Show Hebrew/Greek text">
                        <input type="checkbox" x-model="showInterlinear">
                        <span class="toggle-label-text">Original Language</span>
                    </label>
                    <div class="reading-progress" x-show="highlightedVerses.length > 0 && verses.length > 0">
                        <div class="progress-bar" :style="'width: ' + getReadingProgress() + '%'"></div>
                        <span class="progress-text" x-text="highlightedVerses[0] + '/' + verses.length"></span>
                    </div>
                </div>
                <div class="nav-buttons" x-show="currentReference">
                    <button @click="previousChapter" class="btn-nav" title="Previous chapter">‚Üê Ch</button>
                    <button @click="previousVerse" class="btn-nav" title="Previous verse" :disabled="!canGoPrevVerse()">‚Üê V</button>
                    <button @click="nextVerse" class="btn-nav" title="Next verse" :disabled="!canGoNextVerse()">V ‚Üí</button>
                    <button @click="nextChapter" class="btn-nav" title="Next chapter">Ch ‚Üí</button>
                </div>
            </div>
            <div class="panel-body">
                <div x-show="loading" class="loading">
                    <div class="loading-spinner"></div>
                    <span class="loading-text">Loading passage...</span>
                </div>
                <div x-show="error" class="error" x-text="error"></div>

                <!-- Book selector when no passage loaded -->
                <div x-show="!loading && !error && verses.length === 0" class="book-selector">
                    <p class="book-selector-intro">Select a book to begin reading:</p>
                    <div class="book-section">
                        <h3>Old Testament</h3>
                        <div class="book-grid">
                            <template x-for="book in otBooks" :key="book">
                                <button @click="loadReference(book + ' 1')" class="book-btn" x-text="book"></button>
                            </template>
                        </div>
                    </div>
                    <div class="book-section">
                        <h3>New Testament</h3>
                        <div class="book-grid">
                            <template x-for="book in ntBooks" :key="book">
                                <button @click="loadReference(book + ' 1')" class="book-btn" x-text="book"></button>
                            </template>
                        </div>
                    </div>
                </div>

                <div x-show="!loading && !error && verses.length > 0" class="verses">
                    <template x-for="(verse, verseIdx) in verses" :key="'v-' + verseIdx">
                        <div
                            class="verse-box"
                            :id="'verse-' + verse.verse"
                            :class="{ 'verse-highlighted': isVerseHighlighted(verse.verse), 'has-interlinear': showInterlinear && hasInterlinear(verse.verse) }"
                            @click="handleVerseBoxClick($event, verse.verse)"
                        >
                            <sup class="verse-num" x-text="verse.verse"></sup>
                            <span
                                class="verse-text"
                                x-html="formatVerseText(verse.text)"
                            ></span>
                            <!-- Interlinear display -->
                            <div x-show="showInterlinear && hasInterlinear(verse.verse)" class="interlinear-row" :class="getInterlinearLanguage(verse.verse)">
                                <template x-for="(word, wordIdx) in getInterlinearWords(verse.verse)" :key="'iw-' + verse.verse + '-' + wordIdx">
                                    <span
                                        class="interlinear-word"
                                        @click.stop="handleInterlinearWordClick(word, $event)"
                                        :class="{ 'has-strong': word.strong_number }"
                                        :data-word-id="word.word_id"
                                        :title="(word.transliteration || '') + (word.strong_number ? ' [' + word.strong_number + ']' : '')"
                                    >
                                        <span class="original-text" x-text="word.original_text"></span>
                                        <span class="word-gloss" x-text="getWordGloss(word)"></span>
                                    </span>
                                </template>
                            </div>
                            <button
                                class="btn-copy"
                                @click.stop="copyVerse(verse)"
                                :title="copyFeedback === verse.verse ? 'Copied!' : 'Copy verse'"
                            >
                                <span x-show="copyFeedback !== verse.verse">üìã</span>
                                <span x-show="copyFeedback === verse.verse">‚úì</span>
                            </button>
                        </div>
                    </template>
                </div>
            </div>
        </section>

        <!-- Resources Panel -->
        <section class="panel panel-resources" :class="{ 'expanded': resourcesPanelExpanded }">
            <div class="panel-tabs">
                <button
                    class="tab-drag-handle"
                    @click="resourcesPanelExpanded = !resourcesPanelExpanded"
                    aria-label="Toggle resources panel"
                >
                    <span class="drag-indicator"></span>
                </button>
                <button
                    class="btn-close-panel"
                    @click="resourcesPanelExpanded = false"
                    x-show="resourcesPanelExpanded"
                    aria-label="Close panel"
                >√ó</button>
                <button
                    @click="activeTab = 'commentary'; resourcesPanelExpanded = true"
                    :class="{ 'active': activeTab === 'commentary', 'has-content': commentary.length > 0 }"
                    class="tab-btn"
                >Commentary<span x-show="commentary.length > 0" class="tab-indicator">‚óè</span></button>
                <button
                    @click="activeTab = 'notes'; resourcesPanelExpanded = true"
                    :class="{ 'active': activeTab === 'notes', 'has-content': getRelevantNotes().length > 0 }"
                    class="tab-btn"
                >Notes<span x-show="getRelevantNotes().length > 0" class="tab-indicator" x-text="'(' + getRelevantNotes().length + ')'"></span></button>
                <button
                    @click="activeTab = 'crossrefs'; resourcesPanelExpanded = true"
                    :class="{ 'active': activeTab === 'crossrefs', 'has-content': crossRefs.length > 0 }"
                    class="tab-btn"
                >Cross-Refs<span x-show="crossRefs.length > 0" class="tab-indicator" x-text="'(' + crossRefs.length + ')'"></span></button>
            </div>
            <div class="panel-body">
                <!-- Commentary Tab -->
                <div x-show="activeTab === 'commentary'" class="tab-content">
                    <template x-if="loadingCommentary">
                        <div class="panel-loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </template>
                    <template x-if="!loadingCommentary && !currentReference">
                        <div class="empty-state">
                            <span class="empty-state-icon">üìñ</span>
                            <span class="empty-state-title">Select a passage</span>
                            <span class="empty-state-hint">Commentary will appear here</span>
                        </div>
                    </template>
                    <template x-if="!loadingCommentary && commentary.length === 0 && currentReference">
                        <div class="empty-state">
                            <span class="empty-state-icon">üìù</span>
                            <span class="empty-state-title">No commentary available</span>
                            <span class="empty-state-hint">Try another passage or check back later</span>
                        </div>
                    </template>
                    <!-- Grouped by source with collapsible sections -->
                    <template x-for="(group, source) in getGroupedCommentary()" :key="'comm-group-' + source">
                        <div class="commentary-group">
                            <button
                                class="commentary-group-header"
                                @click="toggleCommentarySource(source)"
                                :class="{ 'expanded': isCommentarySourceExpanded(source) }"
                            >
                                <span class="commentary-source-name" x-text="source"></span>
                                <span class="commentary-entry-count" x-text="'(' + group.length + (group.length === 1 ? ' entry' : ' entries') + ')'"></span>
                                <span class="commentary-toggle-icon" x-text="isCommentarySourceExpanded(source) ? '‚ñº' : '‚ñ∂'"></span>
                            </button>
                            <div class="commentary-preview" x-show="!isCommentarySourceExpanded(source)" x-text="getCommentaryPreview(group)"></div>
                            <div class="commentary-entries" x-show="isCommentarySourceExpanded(source)" x-transition>
                                <template x-for="(entry, idx) in group" :key="'comm-' + source + '-' + idx">
                                    <div class="commentary-entry">
                                        <div class="commentary-content" x-html="entry.content" @click="handleCommentaryClick($event)"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Notes Tab -->
                <div x-show="activeTab === 'notes'" class="tab-content">
                    <template x-if="!currentBook">
                        <div class="empty-state">
                            <span class="empty-state-icon">‚úèÔ∏è</span>
                            <span class="empty-state-title">Select a passage</span>
                            <span class="empty-state-hint">Add your study notes here</span>
                        </div>
                    </template>
                    <template x-if="currentBook">
                        <div class="notes-editor">
                            <div class="note-reference-row">
                                <span class="note-for">Note for:</span>
                                <span class="note-ref" x-text="currentBook + ' ' + currentChapter + ':' + getNoteStartVerse()"></span>
                                <template x-if="showNoteRange">
                                    <span class="note-range-to">
                                        -<input
                                            type="number"
                                            x-model="noteEndVerse"
                                            :min="getNoteStartVerse()"
                                            :max="verses.length"
                                            class="input-end-verse"
                                            placeholder="end"
                                        >
                                    </span>
                                </template>
                                <button
                                    @click="showNoteRange = !showNoteRange; if(!showNoteRange) noteEndVerse = null"
                                    class="btn-range-toggle"
                                    :title="showNoteRange ? 'Single verse' : 'Add verse range'"
                                    x-text="showNoteRange ? '‚àí' : '+'"
                                ></button>
                            </div>
                            <textarea
                                x-model="currentNote"
                                placeholder="Add your notes for this passage..."
                                class="note-textarea"
                            ></textarea>
                            <button @click="saveNote" class="btn-save" :disabled="!currentNote.trim()">
                                Save Note
                            </button>
                        </div>
                    </template>
                    <div class="saved-notes">
                        <template x-for="note in getRelevantNotes()" :key="note.id">
                            <div class="note-card">
                                <div class="note-meta">
                                    <span x-text="formatNoteReference(note)"></span>
                                    <span x-text="formatDate(note.created_at)"></span>
                                    <button @click="deleteNote(note.id)" class="btn-delete-note" title="Delete note">√ó</button>
                                </div>
                                <div class="note-content" x-text="note.content"></div>
                            </div>
                        </template>
                        <template x-if="getRelevantNotes().length === 0 && currentBook">
                            <div class="empty-state" style="padding: 1rem;">
                                <span class="empty-state-hint">No notes for this passage yet</span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Cross-References Tab -->
                <div x-show="activeTab === 'crossrefs'" class="tab-content">
                    <template x-if="!currentReference">
                        <div class="empty-state">
                            <span class="empty-state-icon">üîó</span>
                            <span class="empty-state-title">Select a verse</span>
                            <span class="empty-state-hint">Related passages will appear here</span>
                        </div>
                    </template>
                    <template x-if="crossRefs.length === 0 && currentReference">
                        <div class="empty-state">
                            <span class="empty-state-icon">üîó</span>
                            <span class="empty-state-title">No cross-references</span>
                            <span class="empty-state-hint">This verse has no linked references</span>
                        </div>
                    </template>
                    <ul class="crossref-list">
                        <template x-for="(ref, idx) in crossRefs" :key="'xref-' + idx">
                            <li class="crossref-item"
                                @mouseenter="previewVerse(ref.target_book + ' ' + ref.target_chapter + ':' + ref.target_verse, $event)"
                                @mouseleave="hidePreview()"
                            >
                                <a
                                    href="#"
                                    @click.prevent="loadReference(ref.target_book + ' ' + ref.target_chapter + ':' + ref.target_verse)"
                                    x-text="ref.target_book + ' ' + ref.target_chapter + ':' + ref.target_verse"
                                ></a>
                            </li>
                        </template>
                    </ul>
                </div>

            </div>
        </section>

        <!-- Word Details Panel (shows on word click) -->
        <aside class="panel panel-word" x-show="selectedWord" x-transition>
            <div class="panel-header">
                <h2>Word Details</h2>
                <button @click="selectedWord = null" class="btn-close">√ó</button>
            </div>
            <div class="panel-body" x-show="selectedWord">
                <!-- Show full word details when we have original language data -->
                <template x-if="selectedWord?.original || selectedWord?.strong_number">
                    <div>
                        <div class="word-header">
                            <span class="word-original" :class="selectedWord?.language" x-text="selectedWord?.original || selectedWord?.text"></span>
                            <span class="word-transliteration" x-text="selectedWord?.transliteration || '‚Äî'"></span>
                        </div>
                        <div class="word-strongs" x-show="selectedWord?.strong_number">
                            <span class="strong-badge" :class="selectedWord?.language" x-text="selectedWord?.strong_number"></span>
                            <span class="word-lang-label" x-text="selectedWord?.language === 'hebrew' ? 'Hebrew' : selectedWord?.language === 'greek' ? 'Greek' : ''"></span>
                        </div>
                        <div class="word-pronunciation" x-show="selectedWord?.pronunciation">
                            <em x-text="selectedWord?.pronunciation"></em>
                        </div>
                        <div class="word-definition">
                            <strong>Definition:</strong>
                            <p x-text="selectedWord?.definition || 'No definition available'"></p>
                        </div>
                    </div>
                </template>
                <!-- Show helpful message when clicking English words -->
                <template x-if="!selectedWord?.original && !selectedWord?.strong_number">
                    <div class="word-hint">
                        <div class="word-hint-title">
                            "<span x-text="selectedWord?.text"></span>"
                        </div>
                        <p x-text="selectedWord?.definition"></p>
                    </div>
                </template>
                <div class="word-extended" x-show="selectedWord?.extended_definition">
                    <strong>KJV Usage:</strong>
                    <p x-text="selectedWord?.extended_definition"></p>
                </div>
                <div class="word-derivation" x-show="selectedWord?.derivation">
                    <strong>Derivation:</strong>
                    <p x-text="selectedWord?.derivation"></p>
                </div>
                <div class="word-occurrences" x-show="selectedWord?.count > 0">
                    <h4>Appears <span x-text="selectedWord?.count"></span> times:</h4>
                    <ul class="occurrence-list">
                        <template x-for="(occ, occIdx) in (showAllOccurrences ? (selectedWord?.occurrences || []) : (selectedWord?.occurrences || []).slice(0, 10))" :key="'occ-' + occIdx">
                            <li>
                                <a
                                    href="#"
                                    @click.prevent="loadReference(occ.book + ' ' + occ.chapter + ':' + occ.verse)"
                                    x-text="occ.book + ' ' + occ.chapter + ':' + occ.verse"
                                ></a>
                            </li>
                        </template>
                        <li x-show="selectedWord?.count > 10 && !showAllOccurrences" class="more-occurrences">
                            <a href="#" @click.prevent="showAllOccurrences = true" class="show-more-link">
                                ...and <span x-text="selectedWord?.count - 10"></span> more
                            </a>
                        </li>
                        <li x-show="selectedWord?.count > 10 && showAllOccurrences" class="more-occurrences">
                            <a href="#" @click.prevent="showAllOccurrences = false" class="show-more-link">Show less</a>
                        </li>
                    </ul>
                </div>
            </div>
        </aside>
    </main>

    <!-- Search Modal -->
    <div class="modal-overlay" x-show="showSearch" x-transition @click.self="showSearch = false">
        <div class="modal search-modal">
            <div class="modal-header">
                <h2>Search</h2>
                <button @click="showSearch = false" class="btn-close">√ó</button>
            </div>
            <div class="modal-body">
                <div class="search-input-group">
                    <input
                        type="text"
                        x-model="searchQuery"
                        @input="handleSearchInput"
                        @keydown="handleSearchKeydown"
                        placeholder="Search Bible, commentary... (min 2 chars)"
                        class="input-search"
                        x-ref="searchInput"
                        autocomplete="off"
                    >
                    <select x-model="searchScope" @change="performSearch" class="select-scope">
                        <option value="all">All</option>
                        <option value="bible">Bible Text</option>
                        <option value="ot">Old Testament</option>
                        <option value="nt">New Testament</option>
                        <option :value="'book:' + currentBook" x-show="currentBook" x-text="'In ' + currentBook"></option>
                        <option value="commentary">Commentary</option>
                    </select>
                </div>

                <!-- Loading indicator -->
                <div x-show="searchLoading" class="search-loading">
                    <div class="loading-spinner"></div>
                    <span>Searching...</span>
                </div>

                <!-- No results message -->
                <div x-show="searchPerformed && !searchLoading && searchResults.length === 0" class="search-no-results">
                    <span class="empty-state-icon">üîç</span>
                    <span>No results found for "<span x-text="searchQuery"></span>"</span>
                    <span class="search-tip">Try different keywords or check spelling</span>
                </div>

                <!-- Strong's word info card -->
                <div x-show="searchWordInfo" class="strongs-word-card">
                    <div class="strongs-header">
                        <span class="strongs-number" x-text="searchWordInfo?.strong_number"></span>
                        <span class="strongs-original" x-text="searchWordInfo?.original"></span>
                        <span class="strongs-transliteration" x-text="'(' + (searchWordInfo?.transliteration || '') + ')'"></span>
                    </div>
                    <div class="strongs-definition" x-text="searchWordInfo?.definition"></div>
                </div>

                <!-- Results grouped by type -->
                <div class="search-results" x-show="searchResults.length > 0">
                    <!-- Bible Results -->
                    <template x-if="getGroupedResults().verse.length > 0">
                        <div class="results-group">
                            <div class="results-group-header">
                                <span class="group-icon">üìñ</span>
                                <span x-text="searchWordInfo ? 'Verses with this word' : 'Bible Text'"></span>
                                <span class="group-count" x-text="'(' + getGroupedResults().verse.length + ')'"></span>
                            </div>
                            <template x-for="(result, i) in getGroupedResults().verse" :key="'v' + i">
                                <div
                                    class="search-result"
                                    :class="{ 'selected': selectedResultIndex === searchResults.indexOf(result) }"
                                    @click="goToSearchResult(result)"
                                    @mouseenter="selectedResultIndex = searchResults.indexOf(result)"
                                >
                                    <div class="result-ref">
                                        <span x-text="result.book + ' ' + result.chapter + ':' + result.verse"></span>
                                        <span x-show="result.original_word" class="result-original-word" x-text="result.original_word"></span>
                                    </div>
                                    <div class="result-snippet" x-html="result.snippet"></div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- Commentary Results -->
                    <template x-if="getGroupedResults().commentary.length > 0">
                        <div class="results-group">
                            <div class="results-group-header">
                                <span class="group-icon">üìù</span>
                                Commentary
                                <span class="group-count" x-text="'(' + getGroupedResults().commentary.length + ')'"></span>
                            </div>
                            <template x-for="(result, i) in getGroupedResults().commentary" :key="'c' + i">
                                <div
                                    class="search-result"
                                    :class="{ 'selected': selectedResultIndex === searchResults.indexOf(result) }"
                                    @click="goToSearchResult(result)"
                                    @mouseenter="selectedResultIndex = searchResults.indexOf(result)"
                                >
                                    <div class="result-ref">
                                        <span x-text="result.book + ' ' + result.chapter"></span>
                                        <span class="result-source" x-text="'(' + result.source + ')'"></span>
                                    </div>
                                    <div class="result-snippet" x-html="result.snippet"></div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- Search tips -->
                <div x-show="!searchPerformed && searchQuery.length < 2" class="search-tips">
                    <p><strong>Search tips:</strong></p>
                    <ul>
                        <li>Use quotes for exact phrases: <code>"in the beginning"</code></li>
                        <li>Search Strong's numbers: <code>G26</code> or <code>H430</code></li>
                        <li>Use arrow keys to navigate results</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Verse Preview Tooltip -->
    <div
        x-show="versePreview.show"
        x-transition
        class="verse-preview-tooltip"
        :style="'top: ' + versePreview.y + 'px; left: ' + versePreview.x + 'px;'"
    >
        <div class="preview-ref" x-text="versePreview.reference"></div>
        <div class="preview-text" x-text="versePreview.text"></div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" x-show="showSettings" x-transition @click.self="showSettings = false">
        <div class="modal settings-modal">
            <div class="modal-header">
                <h2>Settings</h2>
                <button @click="showSettings = false" class="btn-close">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Settings Navigation -->
                <div class="settings-nav">
                    <button @click="settingsTab = 'general'" :class="{ active: settingsTab === 'general' }" class="settings-nav-btn">
                        General
                    </button>
                    <button @click="settingsTab = 'offline'" :class="{ active: settingsTab === 'offline' }" class="settings-nav-btn">
                        Offline
                        <span class="offline-badge" :class="isOnline ? 'online' : 'offline'"></span>
                    </button>
                    <button @click="settingsTab = 'shortcuts'" :class="{ active: settingsTab === 'shortcuts' }" class="settings-nav-btn">
                        Shortcuts
                    </button>
                </div>

                <!-- General Settings Tab -->
                <div class="settings-content" x-show="settingsTab === 'general'">
                    <div class="settings-section">
                        <h4>Appearance</h4>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Dark Mode</div>
                                <div class="setting-description">Use dark theme for comfortable reading</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" x-model="darkMode" @change="saveDarkMode()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4>Bible Translation</h4>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Default Translation</div>
                                <div class="setting-description">Used when opening the app</div>
                            </div>
                            <select x-model="defaultTranslation" @change="saveDefaultTranslation()" class="setting-select">
                                <option value="BSB">BSB - Berean Standard</option>
                                <option value="WEB">WEB - World English</option>
                                <option value="KJV">KJV - King James</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4>Reading</h4>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Show Interlinear by Default</div>
                                <div class="setting-description">Display Hebrew/Greek text automatically</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" x-model="defaultShowInterlinear" @change="saveInterlinearPref()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Offline Settings Tab -->
                <div class="settings-content" x-show="settingsTab === 'offline'">
                    <!-- Offline Availability Section -->
                    <div class="offline-availability-header">Offline Availability</div>
                    <div class="offline-status-bar">
                        <span class="status-indicator" :class="isOnline ? 'online' : 'offline'"></span>
                        <span class="status-text" x-text="forcedOffline ? 'Forced Offline' : (isOnline ? 'Online' : 'Offline')"></span>
                        <button @click="toggleForcedOffline()" class="btn-offline-toggle" :class="{ active: forcedOffline }">
                            <span x-text="forcedOffline ? 'Go Online' : 'Go Offline'"></span>
                        </button>
                    </div>

                    <!-- Cache Stats Box - More Prominent -->
                    <div class="cache-stats-box">
                        <div class="cache-stats-header">Cached Data</div>
                        <div class="cache-stats-numbers">
                            <div class="cache-stat">
                                <span class="cache-stat-value" x-text="offlineStats.chapters"></span>
                                <span class="cache-stat-label">Chapters</span>
                            </div>
                            <div class="cache-stat">
                                <span class="cache-stat-value" x-text="offlineStats.verses.toLocaleString()"></span>
                                <span class="cache-stat-label">Verses</span>
                            </div>
                            <div class="cache-stat">
                                <span class="cache-stat-value" x-text="formatStorageSize(offlineStats.estimatedSize)"></span>
                                <span class="cache-stat-label">Storage</span>
                            </div>
                        </div>
                    </div>

                    <!-- Auto-Cache Toggle -->
                    <div class="auto-cache-section">
                        <div class="setting-row compact">
                            <div class="setting-info">
                                <div class="setting-label">Auto-cache browsed chapters</div>
                                <div class="setting-description">Automatically save chapters you read for offline use</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" x-model="autoCacheEnabled" @change="saveAutoCachePref()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Bulk Download Section Header -->
                    <div class="download-section-title">Download for Offline</div>

                    <!-- Translations -->
                    <div class="download-section">
                        <div class="download-section-header">Translations</div>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.translations.BSB">
                            <span>BSB - Berean Standard Bible</span>
                        </label>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.translations.WEB">
                            <span>WEB - World English Bible</span>
                        </label>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.translations.KJV">
                            <span>KJV - King James Version</span>
                        </label>
                    </div>

                    <!-- Commentaries -->
                    <div class="download-section">
                        <div class="download-section-header">Commentaries</div>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.commentaryMH">
                            <span>Matthew Henry Commentary</span>
                        </label>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.commentaryJG">
                            <span>John Gill Commentary</span>
                        </label>
                    </div>

                    <!-- Devotionals -->
                    <div class="download-section">
                        <div class="download-section-header">Devotionals</div>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.devotionalSpurgeon">
                            <span>Spurgeon Morning & Evening</span>
                        </label>
                    </div>

                    <!-- Resources -->
                    <div class="download-section">
                        <div class="download-section-header">Resources</div>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.lexicon">
                            <span>Strong's Lexicon</span>
                        </label>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.crossRefs">
                            <span>Cross-References</span>
                        </label>
                    </div>

                    <!-- Download Progress -->
                    <div class="download-progress" x-show="downloadProgress.active">
                        <div class="progress-header">
                            <span x-text="downloadProgress.label"></span>
                            <span x-text="downloadProgress.percent + '%'"></span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" :style="'width: ' + downloadProgress.percent + '%'"></div>
                        </div>
                        <div class="progress-status" x-text="downloadProgress.status"></div>
                    </div>

                    <!-- Actions -->
                    <div class="download-actions">
                        <button @click="startOfflineDownload()" class="btn-primary" :disabled="downloadProgress.active || !hasDownloadSelections()">
                            Download Selected
                        </button>
                        <button @click="refreshOfflineData()" class="btn-secondary" :disabled="downloadProgress.active">
                            Refresh
                        </button>
                        <button @click="clearOfflineData()" class="btn-danger" :disabled="downloadProgress.active">
                            Clear All
                        </button>
                    </div>
                </div>

                <!-- Shortcuts Tab -->
                <div class="settings-content" x-show="settingsTab === 'shortcuts'">
                    <div class="settings-section">
                        <h4>Navigation</h4>
                        <div class="shortcuts-list">
                            <div class="shortcut-item">
                                <span class="shortcut-keys"><kbd>‚Üê</kbd> <kbd>‚Üí</kbd></span>
                                <span class="shortcut-desc">Previous / Next chapter</span>
                            </div>
                            <div class="shortcut-item">
                                <span class="shortcut-keys"><kbd>‚Üë</kbd> <kbd>‚Üì</kbd></span>
                                <span class="shortcut-desc">Previous / Next verse</span>
                            </div>
                            <div class="shortcut-item">
                                <span class="shortcut-keys"><kbd>G</kbd></span>
                                <span class="shortcut-desc">Go to reference input</span>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4>Actions</h4>
                        <div class="shortcuts-list">
                            <div class="shortcut-item">
                                <span class="shortcut-keys"><kbd>/</kbd></span>
                                <span class="shortcut-desc">Open search</span>
                            </div>
                            <div class="shortcut-item">
                                <span class="shortcut-keys"><kbd>C</kbd></span>
                                <span class="shortcut-desc">Copy current verse</span>
                            </div>
                            <div class="shortcut-item">
                                <span class="shortcut-keys"><kbd>D</kbd></span>
                                <span class="shortcut-desc">Toggle dark mode</span>
                            </div>
                            <div class="shortcut-item">
                                <span class="shortcut-keys"><kbd>Esc</kbd></span>
                                <span class="shortcut-desc">Close panels / modals</span>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4>Tips</h4>
                        <ul class="tips-list">
                            <li>Click any verse to see commentary and cross-references</li>
                            <li>Click any word (in BSB) to see Hebrew/Greek details</li>
                            <li>Enable "Original Language" to see interlinear text</li>
                            <li>URLs update as you navigate - share or bookmark any verse</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container">
        <template x-for="toast in toasts" :key="toast.id">
            <div class="toast" :class="toast.type" x-transition>
                <span x-text="toast.message"></span>
            </div>
        </template>
    </div>

    <script src="/static/js/offline-storage.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
        // Show cache toast notification
        function showCacheToast(message) {
            const toast = document.getElementById('cache-toast');
            if (!toast) return;

            const msgEl = toast.querySelector('.toast-message');
            if (msgEl) msgEl.textContent = message;

            // Reset animation by cloning
            const newToast = toast.cloneNode(true);
            newToast.style.display = 'flex';
            toast.parentNode.replaceChild(newToast, toast);

            // Hide after animation completes
            setTimeout(() => {
                newToast.style.display = 'none';
            }, 2250);
        }

        // Forced offline mode - intercept all fetch requests
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            const url = typeof args[0] === 'string' ? args[0] : args[0]?.url;

            // Log API requests to help debug caching
            if (url?.includes('/api/')) {
                console.log('[Main] Fetch API:', url);
            }

            // Check if forced offline mode is enabled
            if (localStorage.getItem('forcedOffline') === 'true') {
                // Block the request and return an error that triggers offline fallback
                throw new TypeError('Network request blocked - forced offline mode');
            }
            return originalFetch.apply(this, args);
        };

        // Register service worker for offline support
        // Note: Service workers only work on localhost or HTTPS
        const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        const isSecure = location.protocol === 'https:';

        if ('serviceWorker' in navigator && (isLocalhost || isSecure)) {
            navigator.serviceWorker.register('/static/sw.js')
                .then(reg => {
                    console.log('[Main] Service worker registered:', reg.scope);
                    console.log('[Main] SW state:', reg.installing ? 'installing' : reg.waiting ? 'waiting' : reg.active ? 'active' : 'unknown');

                    // Listen for updates
                    reg.addEventListener('updatefound', () => {
                        console.log('[Main] Service worker update found');
                        const newWorker = reg.installing;
                        newWorker?.addEventListener('statechange', () => {
                            console.log('[Main] New SW state:', newWorker.state);
                        });
                    });
                })
                .catch(err => console.log('[Main] Service worker registration failed:', err));

            // Wait for service worker to be ready
            navigator.serviceWorker.ready.then(reg => {
                console.log('[Main] Service worker ready, controller:', !!navigator.serviceWorker.controller);
            });
        } else if (!isLocalhost && !isSecure) {
            console.warn('[Main] Service worker disabled: requires localhost or HTTPS. Current:', location.hostname);
        }

        // Handle messages from service worker to cache data in IndexedDB
        navigator.serviceWorker?.addEventListener('message', async (event) => {
            const { type, cacheType, data, pathname } = event.data || {};

            console.log('[Main] SW Message received:', type, cacheType, pathname);

            if (type !== 'CACHE_DATA' || !window.offlineStorage) {
                console.log('[SW Message] Skipping - type:', type, 'storage:', !!window.offlineStorage);
                return;
            }

            // Check if auto-caching is enabled
            if (localStorage.getItem('autoCacheEnabled') === 'false') {
                console.log('[SW Message] Auto-cache disabled');
                return;
            }

            try {
                // Parse reference from pathname to determine book/chapter
                const refMatch = pathname.match(/\/api\/passage\/([^/?]+)/);
                if (!refMatch) return;

                const ref = decodeURIComponent(refMatch[1]);
                const parsedRef = ref.match(/^(.+?)\s+(\d+)/);
                if (!parsedRef) return;

                const book = parsedRef[1];
                const chapter = parseInt(parsedRef[2]);

                let cached = false;
                switch (cacheType) {
                    case 'passage':
                        // Cache verses
                        if (data.verses && data.verses.length > 0) {
                            const translation = new URLSearchParams(pathname.split('?')[1]).get('translation') || 'BSB';
                            await window.offlineStorage.saveChapterVerses(translation, book, chapter, data.verses);
                            showCacheToast(`Cached ${book} ${chapter}`);
                            cached = true;
                        }
                        break;

                    case 'interlinear':
                        // Cache interlinear data
                        if (data.verses) {
                            const allWords = [];
                            for (const [verseNum, words] of Object.entries(data.verses)) {
                                for (const word of words) {
                                    allWords.push({ ...word, verse: parseInt(verseNum) });
                                }
                            }
                            if (allWords.length > 0) {
                                await window.offlineStorage.saveChapterInterlinear(book, chapter, allWords);
                                cached = true;
                            }
                        }
                        break;

                    case 'commentary':
                        // Cache commentary
                        if (data.entries && data.entries.length > 0) {
                            await window.offlineStorage.saveChapterCommentary(book, chapter, data.entries);
                            cached = true;
                        }
                        break;

                    case 'crossrefs':
                        // Cache cross-references
                        if (data.cross_references && data.cross_references.length > 0) {
                            await window.offlineStorage.saveChapterCrossRefs(book, chapter, data.cross_references);
                            cached = true;
                        }
                        break;

                    case 'lexicon':
                        // Cache lexicon entry
                        if (data.word) {
                            await window.offlineStorage.saveLexiconEntries([data.word]);
                            cached = true;
                        }
                        break;
                }

                // Refresh offline stats in the Alpine app
                if (cached) {
                    console.log('[Main] Cached data:', cacheType, book, chapter);
                    const alpineApp = document.querySelector('[x-data]')?.__x?.$data;
                    if (alpineApp && typeof alpineApp.updateOfflineStats === 'function') {
                        alpineApp.updateOfflineStats();
                    }
                }
            } catch (err) {
                console.warn('Failed to cache data in IndexedDB:', err);
            }
        });
    </script>
</body>
</html>
