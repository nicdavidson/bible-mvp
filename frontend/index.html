<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Free, open-source Bible study platform with cross-resource linking">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="In the Word">
    <title>In the Word - Free Bible Study Tool</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/static/icons/icon.svg">
    <link rel="apple-touch-icon" href="/static/icons/icon.svg">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="/static/js/supabase-client.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="bibleApp()" x-init="init()" :class="{ 'dark': darkMode }">
    <!-- Toast notification for caching feedback -->
    <div id="cache-toast" class="cache-toast" style="display: none;">
        <span class="toast-icon">&#10003;</span>
        <span class="toast-message"></span>
    </div>

    <!-- Side Menu Overlay -->
    <div class="side-menu-overlay" x-show="showSideMenu" x-transition.opacity @click="showSideMenu = false"></div>

    <!-- Side Menu -->
    <nav class="side-menu" :class="{ 'open': showSideMenu }">
        <div class="side-menu-header">
            <span class="side-menu-title">In the Word</span>
            <button @click="showSideMenu = false" class="side-menu-close">&times;</button>
        </div>

        <div class="side-menu-content">
            <div class="side-menu-section">
                <button @click="navigateTo('reader')" class="side-menu-item" :class="{ 'active': currentView === 'reader' }">
                    <span class="side-menu-icon">üìñ</span>
                    <span>Get in the Word</span>
                </button>
                <button @click="openTodaysReading()" class="side-menu-item" x-show="currentPlan">
                    <span class="side-menu-icon">üìÖ</span>
                    <span>Today's Reading</span>
                </button>
                <button @click="navigateTo('plans')" class="side-menu-item">
                    <span class="side-menu-icon">üìö</span>
                    <span>Reading Plans</span>
                </button>
            </div>

            <div class="side-menu-divider"></div>

            <div class="side-menu-section">
                <button @click="openShareJesus()" class="side-menu-item">
                    <span class="side-menu-icon">‚úùÔ∏è</span>
                    <span>Share Jesus</span>
                </button>
            </div>

            <div class="side-menu-divider"></div>

            <div class="side-menu-section">
                <button @click="openSettingsFromMenu()" class="side-menu-item">
                    <span class="side-menu-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </button>
                <button @click="openGuide()" class="side-menu-item">
                    <span class="side-menu-icon">üìò</span>
                    <span>Guide</span>
                </button>
                <button @click="openAbout()" class="side-menu-item">
                    <span class="side-menu-icon">‚ÑπÔ∏è</span>
                    <span>About</span>
                </button>
            </div>
        </div>

        <div class="side-menu-footer">
            <template x-if="authUser">
                <div class="side-menu-user">
                    <span class="side-menu-user-email" x-text="authUser.email"></span>
                    <button @click="handleSignOut(); showSideMenu = false;" class="side-menu-signout">Sign Out</button>
                </div>
            </template>
            <template x-if="!authUser">
                <button @click="openSettingsFromMenu('account')" class="side-menu-signin">Sign In</button>
            </template>
        </div>
    </nav>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button @click="showSideMenu = true" class="btn-hamburger" title="Menu">
                <span class="hamburger-icon">‚ò∞</span>
            </button>
        </div>
        <div class="header-center">
            <div class="reference-input">
                <button @click="toggleBookPicker" class="btn-picker" title="Browse books">
                    <span class="picker-icon">üìñ</span>
                </button>
                <div class="autocomplete-wrapper">
                    <input
                        type="text"
                        x-model="referenceInput"
                        x-ref="referenceInput"
                        @input="updateSuggestions"
                        @keydown="handleInputKeydown"
                        @blur="hideSuggestions"
                        @focus="updateSuggestions"
                        placeholder="Enter reference (e.g., John 3:16)"
                        class="input-reference"
                        autocomplete="off"
                    >
                    <ul class="autocomplete-dropdown" x-show="showSuggestions" x-transition>
                        <template x-for="(book, index) in bookSuggestions" :key="book">
                            <li
                                @mousedown.prevent="selectSuggestion(book)"
                                :class="{ 'selected': index === selectedSuggestionIndex }"
                                class="autocomplete-item"
                                x-text="book"
                            ></li>
                        </template>
                    </ul>
                </div>
                <select x-model="translation" class="select-translation" title="Bible Translation">
                    <option value="BSB">BSB - Berean Standard</option>
                    <option value="WEB">WEB - World English</option>
                    <option value="KJV">KJV - King James</option>
                </select>
                <button @click="loadPassage" class="btn-go">Go</button>
            </div>

            <!-- Book Picker Dropdown -->
            <div class="book-picker-dropdown" x-show="showBookPicker" x-transition @click.outside="showBookPicker = false">
                <div class="picker-content">
                    <!-- Translation selector (mobile only - shown via CSS) -->
                    <div class="picker-translation-mobile">
                        <label>Translation:</label>
                        <select x-model="translation" class="picker-translation-select">
                            <option value="BSB">BSB - Berean Standard Bible</option>
                            <option value="WEB">WEB - World English Bible</option>
                            <option value="KJV">KJV - King James Version</option>
                        </select>
                    </div>
                    <!-- Book selection -->
                    <div class="picker-books" x-show="!pickerSelectedBook">
                        <div class="picker-section">
                            <h4>Old Testament</h4>
                            <div class="picker-book-grid">
                                <template x-for="book in otBooks" :key="book">
                                    <button @click="selectPickerBook(book)" class="picker-book-btn" :class="'genre-' + getBookGenre(book)" x-text="book"></button>
                                </template>
                            </div>
                        </div>
                        <div class="picker-section">
                            <h4>New Testament</h4>
                            <div class="picker-book-grid">
                                <template x-for="book in ntBooks" :key="book">
                                    <button @click="selectPickerBook(book)" class="picker-book-btn" :class="'genre-' + getBookGenre(book)" x-text="book"></button>
                                </template>
                            </div>
                        </div>
                    </div>
                    <!-- Chapter selection -->
                    <div class="picker-chapters" x-show="pickerSelectedBook">
                        <div class="picker-header">
                            <button @click="pickerSelectedBook = null" class="picker-back-btn">‚Üê Back</button>
                            <span class="picker-book-title" x-text="pickerSelectedBook"></span>
                        </div>
                        <div class="picker-chapter-grid">
                            <template x-for="ch in getChaptersArray(pickerSelectedBook)" :key="ch">
                                <button @click="selectPickerChapter(ch)" class="picker-chapter-btn" x-text="ch"></button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="offline-indicator" :class="isOnline ? 'online' : 'offline'" @click="openSettingsFromMenu('offline')" :title="isOnline ? 'Online' : 'Offline - using cached data'">
                <span class="status-dot"></span>
                <span class="offline-label" x-text="isOnline ? '' : 'Offline'"></span>
            </div>
            <button @click="openSearch()" class="btn-icon" title="Search (/)">
                üîç
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Bible Text Panel -->
        <section class="panel panel-text">
            <div class="panel-header">
                <h2 x-text="currentReference || 'Select a passage'"></h2>
                <div class="header-controls" x-show="currentReference">
                    <label class="interlinear-toggle-header" x-show="combinedPlanReading || otBooks.includes(currentBook) || ntBooks.includes(currentBook)" title="Show Hebrew/Greek text">
                        <input type="checkbox" x-model="showInterlinear">
                        <span class="toggle-label-text">Original Language</span>
                    </label>
                    <div class="reading-progress" x-show="highlightedVerses.length > 0 && verses.length > 0">
                        <div class="progress-bar" :style="'width: ' + getReadingProgress() + '%'"></div>
                        <span class="progress-text" x-text="highlightedVerses[0] + '/' + verses.length"></span>
                    </div>
                </div>
                <div class="nav-buttons" x-show="currentReference">
                    <button @click="previousChapter" class="btn-nav" title="Previous chapter">‚Üê Ch</button>
                    <button @click="previousVerse" class="btn-nav" title="Previous verse" :disabled="!canGoPrevVerse()">‚Üê V</button>
                    <button @click="nextVerse" class="btn-nav" title="Next verse" :disabled="!canGoNextVerse()">V ‚Üí</button>
                    <button @click="nextChapter" class="btn-nav" title="Next chapter">Ch ‚Üí</button>
                </div>
            </div>

            <!-- "Return to Plan" bar (shown when navigated away from plan reading) - sticky below header -->
            <div x-show="wasInPlanReading && currentPlan && !combinedPlanReading" class="plan-return-bar">
                <span class="return-hint">You were reading Day <span x-text="planDay"></span> of <span x-text="currentPlan?.name"></span></span>
                <button @click="returnToPlanReading()" class="btn-return-plan">Return to Plan Reading</button>
                <button @click="wasInPlanReading = false" class="btn-dismiss-return" title="Dismiss">√ó</button>
            </div>

            <!-- Plan reading header bar (shown when in combined plan reading mode) - sticky below header -->
            <div x-show="combinedPlanReading && currentPlan" class="plan-reading-bar">
                <button @click="exitPlanReading()" class="btn-exit-plan" title="Exit to normal Bible view">‚úï Exit</button>
                <div class="plan-reading-info">
                    <div class="plan-title-row">
                        <span class="plan-name" x-text="currentPlan?.name"></span>
                        <span class="plan-day-label" x-text="'Day ' + planDay"></span>
                    </div>
                    <div class="plan-readings-subtitle" x-show="getPlanDayReadings(planDay)">
                        <span x-text="getPlanDayReadings(planDay)?.chronological"></span>
                        <span x-show="getPlanDayReadings(planDay)?.psalms"> ¬∑ </span>
                        <span x-text="getPlanDayReadings(planDay)?.psalms"></span>
                        <span x-show="getPlanDayReadings(planDay)?.proverbs"> ¬∑ </span>
                        <span x-text="getPlanDayReadings(planDay)?.proverbs"></span>
                    </div>
                </div>
                <button @click="markPlanDayAndContinue()" class="btn-complete-day">
                    <span x-text="isDayCompleted(planDay) ? 'Next Day ‚Üí' : 'Complete & Next ‚Üí'"></span>
                </button>
            </div>

            <!-- Single verse full passage bar (shown when viewing full passage from single verse mode) -->
            <div x-show="singleVerseFullPassage" class="single-verse-passage-bar">
                <button @click="returnToSingleVerseMode()" class="btn-exit-plan" title="Back to verse view">‚Üê Back to Verses</button>
                <div class="single-verse-passage-info">
                    <span x-text="getCurrentSingleVerse()?.ref"></span>
                </div>
            </div>

            <div class="panel-body">
                <div x-show="loading" class="loading">
                    <div class="loading-spinner"></div>
                    <span class="loading-text">Loading passage...</span>
                </div>
                <div x-show="error" class="error" x-text="error"></div>

                <!-- Book selector when no passage loaded -->
                <div x-show="!loading && !error && verses.length === 0" class="book-selector">
                    <p class="book-selector-intro">Select a book to begin reading:</p>
                    <div class="book-section">
                        <h3>Old Testament</h3>
                        <div class="book-grid">
                            <template x-for="book in otBooks" :key="book">
                                <button @click="loadReference(book + ' 1')" class="book-btn" :class="'genre-' + getBookGenre(book)" x-text="book"></button>
                            </template>
                        </div>
                    </div>
                    <div class="book-section">
                        <h3>New Testament</h3>
                        <div class="book-grid">
                            <template x-for="book in ntBooks" :key="book">
                                <button @click="loadReference(book + ' 1')" class="book-btn" :class="'genre-' + getBookGenre(book)" x-text="book"></button>
                            </template>
                        </div>
                    </div>
                </div>

                <div x-show="!loading && !error && verses.length > 0" class="verses" :class="{ 'selection-mode': noteEditMode }">
                    <template x-for="(verse, verseIdx) in verses" :key="'v-' + verseIdx">
                        <div class="verse-wrapper" :class="{ 'has-section-header': verse._chapterStart && combinedPlanReading }">
                            <!-- Section/Chapter header for combined plan reading -->
                            <div x-show="verse._chapterStart && combinedPlanReading" class="combined-section-header" :class="['section-' + verse._sectionType, verse._sectionLabel ? 'has-section-label' : 'chapter-only']">
                                <span class="section-label" x-text="verse._sectionLabel" x-show="verse._sectionLabel"></span>
                                <span class="section-ref" x-text="verse._chapterRef"></span>
                            </div>
                            <div
                                class="verse-box"
                                :id="'verse-' + verse.verse"
                                :class="{
                                    'verse-highlighted': isVerseHighlighted(verse.verse),
                                    'has-interlinear': showInterlinear && hasInterlinear(verse.verse, verseIdx),
                                    'verse-selected-for-note': noteEditMode && isVerseSelectedForNote(verse.verse)
                                }"
                                @click="handleVerseBoxClick($event, verse.verse, verseIdx)"
                            >
                            <!-- Tag indicator dots -->
                            <span class="verse-tag-dots" x-show="getVerseTagColors(verse.verse).length > 0">
                                <template x-for="(color, idx) in getVerseTagColors(verse.verse)" :key="'dot-' + verse.verse + '-' + idx">
                                    <span class="tag-dot" :style="'background-color: ' + color"></span>
                                </template>
                            </span>
                            <sup class="verse-num" x-text="verse.verse"></sup>
                            <span
                                class="verse-text"
                                :class="{ 'red-letter': isRedLetterVerse(verse.verse) }"
                                x-html="formatVerseText(verse.text)"
                            ></span>
                            <!-- Interlinear display -->
                            <div x-show="showInterlinear && hasInterlinear(verse.verse, verseIdx)" class="interlinear-row" :class="getInterlinearLanguage(verse.verse, verseIdx)">
                                <template x-for="(word, wordIdx) in getInterlinearWords(verse.verse, verseIdx)" :key="'iw-' + verseIdx + '-' + wordIdx">
                                    <span
                                        class="interlinear-word"
                                        @click.stop="handleInterlinearWordClick(word, $event)"
                                        :class="{ 'has-strong': word.strong_number }"
                                        :data-word-id="word.word_id"
                                        :title="(word.transliteration || '') + (word.strong_number ? ' [' + word.strong_number + ']' : '')"
                                    >
                                        <span class="original-text" x-text="word.original_text"></span>
                                        <span class="word-gloss" x-text="getWordGloss(word)"></span>
                                    </span>
                                </template>
                            </div>
                            <button
                                class="btn-copy"
                                @click.stop="copyVerse(verse)"
                                :title="copyFeedback === verse.verse ? 'Copied!' : 'Copy verse'"
                            >
                                <span x-show="copyFeedback !== verse.verse">üìã</span>
                                <span x-show="copyFeedback === verse.verse">‚úì</span>
                            </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </section>

        <!-- Resources Panel -->
        <section class="panel panel-resources" :class="{ 'expanded': resourcesPanelExpanded }">
            <div class="panel-tabs">
                <button
                    class="tab-drag-handle"
                    @click="resourcesPanelExpanded = !resourcesPanelExpanded"
                    aria-label="Toggle resources panel"
                >
                    <span class="drag-indicator"></span>
                </button>
                <button
                    class="btn-close-panel"
                    @click="resourcesPanelExpanded = false"
                    x-show="resourcesPanelExpanded"
                    aria-label="Close panel"
                >√ó</button>
                <button
                    @click="activeTab = 'commentary'; resourcesPanelExpanded = true"
                    :class="{ 'active': activeTab === 'commentary', 'has-content': commentary.length > 0 }"
                    class="tab-btn"
                >Commentary<span x-show="commentary.length > 0" class="tab-indicator">‚óè</span></button>
                <button
                    @click="activeTab = 'notes'; resourcesPanelExpanded = true"
                    :class="{ 'active': activeTab === 'notes', 'has-content': getRelevantNotes().length > 0 }"
                    class="tab-btn"
                >Notes<span x-show="getRelevantNotes().length > 0" class="tab-indicator" x-text="'(' + getRelevantNotes().length + ')'"></span></button>
                <button
                    @click="activeTab = 'crossrefs'; resourcesPanelExpanded = true"
                    :class="{ 'active': activeTab === 'crossrefs', 'has-content': crossRefs.length > 0 }"
                    class="tab-btn"
                >Cross-Refs<span x-show="crossRefs.length > 0" class="tab-indicator" x-text="'(' + crossRefs.length + ')'"></span></button>
            </div>
            <div class="panel-body">
                <!-- Commentary Tab -->
                <div x-show="activeTab === 'commentary'" class="tab-content">
                    <template x-if="loadingCommentary">
                        <div class="panel-loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </template>
                    <template x-if="!loadingCommentary && !currentReference">
                        <div class="empty-state">
                            <span class="empty-state-icon">üìñ</span>
                            <span class="empty-state-title">Select a passage</span>
                            <span class="empty-state-hint">Commentary will appear here</span>
                        </div>
                    </template>
                    <template x-if="!loadingCommentary && commentary.length === 0 && currentReference">
                        <div class="empty-state">
                            <span class="empty-state-icon">üìù</span>
                            <span class="empty-state-title">No commentary available</span>
                            <span class="empty-state-hint">Try another passage or check back later</span>
                        </div>
                    </template>
                    <!-- Normal mode OR verse selected in combined mode: Grouped by source with collapsible sections -->
                    <template x-if="!combinedPlanReading || highlightedVerses.length > 0">
                        <div>
                            <template x-for="(group, source) in getGroupedCommentary()" :key="'comm-group-' + source">
                                <div class="commentary-group">
                                    <button
                                        class="commentary-group-header"
                                        @click="toggleCommentarySource(source)"
                                        :class="{ 'expanded': isCommentarySourceExpanded(source) }"
                                    >
                                        <span class="commentary-source-name" x-text="source"></span>
                                        <span class="commentary-entry-count" x-text="'(' + group.length + (group.length === 1 ? ' entry' : ' entries') + ')'"></span>
                                        <span class="commentary-toggle-icon" x-text="isCommentarySourceExpanded(source) ? '‚ñº' : '‚ñ∂'"></span>
                                    </button>
                                    <div class="commentary-preview" x-show="!isCommentarySourceExpanded(source)" x-text="getCommentaryPreview(group)"></div>
                                    <div class="commentary-entries" x-show="isCommentarySourceExpanded(source)" x-transition>
                                        <template x-for="(entry, idx) in group" :key="'comm-' + source + '-' + idx">
                                            <div class="commentary-entry" :class="{ 'commentary-active': commentaryMatchesActiveVerse(entry) }">
                                                <button
                                                    class="commentary-verse-ref"
                                                    x-show="entry.reference_start"
                                                    @click="selectVerseFromRef(entry.reference_start)"
                                                    x-text="'v. ' + entry.reference_start + (entry.reference_end && entry.reference_end !== entry.reference_start ? '-' + entry.reference_end : '')"
                                                ></button>
                                                <div class="commentary-content" x-html="entry.content" @click="handleCommentaryClick($event)"></div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- Combined plan reading mode (no verse selected): Grouped by chapter, then by source -->
                    <template x-if="combinedPlanReading && highlightedVerses.length === 0">
                        <div>
                            <template x-for="chapterKey in getCommentaryChapterKeys()" :key="'ch-' + chapterKey">
                                <div class="commentary-chapter-group">
                                    <button
                                        class="commentary-chapter-header"
                                        @click="toggleCommentaryChapter(chapterKey)"
                                        :class="{ 'expanded': isCommentaryChapterExpanded(chapterKey) }"
                                    >
                                        <span class="commentary-chapter-name" x-text="chapterKey"></span>
                                        <span class="commentary-toggle-icon" x-text="isCommentaryChapterExpanded(chapterKey) ? '‚ñº' : '‚ñ∂'"></span>
                                    </button>
                                    <div class="commentary-chapter-content" x-show="isCommentaryChapterExpanded(chapterKey)" x-transition>
                                        <template x-for="(entries, source) in getGroupedCommentaryByChapter()[chapterKey]" :key="'ch-src-' + chapterKey + '-' + source">
                                            <div class="commentary-group">
                                                <button
                                                    class="commentary-group-header"
                                                    @click="toggleCommentarySource(chapterKey + '-' + source)"
                                                    :class="{ 'expanded': isCommentarySourceExpanded(chapterKey + '-' + source) }"
                                                >
                                                    <span class="commentary-source-name" x-text="source"></span>
                                                    <span class="commentary-entry-count" x-text="'(' + entries.length + ')'"></span>
                                                    <span class="commentary-toggle-icon" x-text="isCommentarySourceExpanded(chapterKey + '-' + source) ? '‚ñº' : '‚ñ∂'"></span>
                                                </button>
                                                <div class="commentary-entries" x-show="isCommentarySourceExpanded(chapterKey + '-' + source)" x-transition>
                                                    <template x-for="(entry, idx) in entries" :key="'ch-comm-' + chapterKey + '-' + source + '-' + idx">
                                                        <div class="commentary-entry">
                                                            <button
                                                                class="commentary-verse-ref"
                                                                x-show="entry.reference_start"
                                                                @click="selectVerseFromRef(entry.reference_start)"
                                                                x-text="'v. ' + entry.reference_start + (entry.reference_end && entry.reference_end !== entry.reference_start ? '-' + entry.reference_end : '')"
                                                            ></button>
                                                            <div class="commentary-content" x-html="entry.content" @click="handleCommentaryClick($event)"></div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- Notes Tab -->
                <div x-show="activeTab === 'notes'" class="tab-content">
                    <template x-if="!currentBook && !combinedPlanReading">
                        <div class="empty-state">
                            <span class="empty-state-icon">‚úèÔ∏è</span>
                            <span class="empty-state-title">Select a passage</span>
                            <span class="empty-state-hint">Add your study notes here</span>
                        </div>
                    </template>
                    <!-- Combined reading mode note about adding notes -->
                    <template x-if="combinedPlanReading">
                        <div class="combined-notes-header">
                            <span class="combined-notes-hint">Viewing notes from today's readings. Click a verse reference to edit notes for that passage.</span>
                        </div>
                    </template>
                    <template x-if="currentBook">
                        <div class="notes-editor">
                            <!-- Verse selection mode toggle -->
                            <div class="note-mode-row">
                                <button
                                    @click="toggleNoteEditMode()"
                                    class="btn-select-verses"
                                    :class="{ active: noteEditMode }"
                                >
                                    <span x-show="!noteEditMode">Select Verses</span>
                                    <span x-show="noteEditMode">Done Selecting</span>
                                </button>
                                <span x-show="noteEditMode" class="select-hint">Click verses to select them</span>
                            </div>

                            <!-- Reference display -->
                            <div class="note-reference-row">
                                <span class="note-for">Note for:</span>
                                <template x-if="noteEditMode && selectedVerses.length > 0">
                                    <span class="note-ref" x-text="currentBook + ' ' + currentChapter + ':' + getSelectedVerseRange()"></span>
                                </template>
                                <template x-if="!noteEditMode || selectedVerses.length === 0">
                                    <span class="note-ref" x-text="currentBook + ' ' + currentChapter + ':' + getNoteStartVerse()"></span>
                                </template>
                                <template x-if="!noteEditMode && !showNoteRange">
                                    <button
                                        @click="showNoteRange = true"
                                        class="btn-range-toggle"
                                        title="Add verse range"
                                    >+</button>
                                </template>
                                <template x-if="!noteEditMode && showNoteRange">
                                    <span class="note-range-to">
                                        -<input
                                            type="number"
                                            x-model="noteEndVerse"
                                            :min="getNoteStartVerse()"
                                            :max="verses.length"
                                            class="input-end-verse"
                                            placeholder="end"
                                        >
                                        <button
                                            @click="showNoteRange = false; noteEndVerse = null"
                                            class="btn-range-toggle"
                                            title="Single verse"
                                        >‚àí</button>
                                    </span>
                                </template>
                            </div>

                            <textarea
                                x-model="currentNote"
                                placeholder="Add your notes for this passage..."
                                class="note-textarea"
                            ></textarea>

                            <!-- Tag picker for new notes -->
                            <div class="note-tag-section" x-show="tags.length > 0">
                                <span class="note-tag-label">Tags:</span>
                                <div class="note-tag-list">
                                    <template x-for="tag in tags" :key="'pick-' + tag.id">
                                        <button
                                            type="button"
                                            class="note-tag-chip selectable"
                                            :class="{ selected: isPendingTag(tag.id) }"
                                            :style="'background-color: ' + tag.color"
                                            @click="togglePendingTag(tag.id)"
                                            x-text="tag.name"
                                        ></button>
                                    </template>
                                </div>
                                <span class="note-tag-hint" x-show="pendingNoteTags.length === 0">Click tags to select</span>
                                <span class="note-tag-hint" x-show="pendingNoteTags.length > 0" x-text="pendingNoteTags.length + ' tag' + (pendingNoteTags.length === 1 ? '' : 's') + ' selected'"></span>
                            </div>

                            <button @click="saveNote" class="btn-save" :disabled="!currentNote.trim()">
                                Save Note
                            </button>
                        </div>
                    </template>
                    <div class="saved-notes">
                        <template x-for="note in getRelevantNotes()" :key="note.id">
                            <div class="note-card" :class="{ 'note-active': noteMatchesActiveVerse(note), 'note-editing': editingNoteId === note.id }">
                                <div class="note-meta">
                                    <button class="note-verse-ref" @click="selectVerseFromRef(note.startVerse)" x-text="formatNoteReference(note)"></button>
                                    <span x-text="formatDate(note.created_at)"></span>
                                    <button @click="startEditNote(note)" class="btn-edit-note" title="Edit note" x-show="editingNoteId !== note.id">‚úé</button>
                                    <button @click="deleteNote(note.id)" class="btn-delete-note" title="Delete note" x-show="editingNoteId !== note.id">√ó</button>
                                </div>
                                <!-- View mode -->
                                <template x-if="editingNoteId !== note.id">
                                    <div class="note-content" x-html="formatNoteContent(note.content)" @click="handleNoteRefClick($event)"></div>
                                </template>
                                <!-- Edit mode -->
                                <template x-if="editingNoteId === note.id">
                                    <div class="note-edit-form">
                                        <textarea
                                            x-model="editingNoteContent"
                                            class="note-textarea"
                                            @keydown.escape="cancelEditNote()"
                                        ></textarea>
                                        <div class="note-edit-actions">
                                            <button @click="saveEditNote(note)" class="btn-save-edit" :disabled="!editingNoteContent.trim()">Save</button>
                                            <button @click="cancelEditNote()" class="btn-cancel-edit">Cancel</button>
                                        </div>
                                    </div>
                                </template>
                                <!-- Tags on this note -->
                                <div class="note-tags" x-show="getNoteTagObjects(note.id).length > 0 || tags.length > 0">
                                    <template x-for="tag in getNoteTagObjects(note.id)" :key="'nt-' + note.id + '-' + tag.id">
                                        <span
                                            class="note-tag-badge"
                                            :style="'background-color: ' + tag.color"
                                            @click="toggleNoteTag(note.id, tag.id)"
                                            :title="'Click to remove ' + tag.name"
                                            x-text="tag.name"
                                        ></span>
                                    </template>
                                    <!-- Add tag button -->
                                    <div class="add-tag-dropdown" x-data="{ open: false }">
                                        <button @click="open = !open" class="btn-add-tag" title="Add tag">+</button>
                                        <div class="tag-dropdown-menu" x-show="open" @click.outside="open = false" x-transition>
                                            <template x-for="tag in tags.filter(t => !noteHasTag(note.id, t.id))" :key="'add-' + note.id + '-' + tag.id">
                                                <button
                                                    class="tag-dropdown-item"
                                                    @click="toggleNoteTag(note.id, tag.id); open = false"
                                                >
                                                    <span class="tag-color-dot" :style="'background-color: ' + tag.color"></span>
                                                    <span x-text="tag.name"></span>
                                                </button>
                                            </template>
                                            <template x-if="tags.filter(t => !noteHasTag(note.id, t.id)).length === 0">
                                                <div class="tag-dropdown-empty">All tags applied</div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <template x-if="getRelevantNotes().length === 0 && (currentBook || combinedPlanReading)">
                            <div class="empty-state" style="padding: 1rem;">
                                <span class="empty-state-hint" x-text="combinedPlanReading ? 'No notes for today\\'s readings' : 'No notes for this passage yet'"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Cross-References Tab -->
                <div x-show="activeTab === 'crossrefs'" class="tab-content">
                    <template x-if="!currentReference">
                        <div class="empty-state">
                            <span class="empty-state-icon">üîó</span>
                            <span class="empty-state-title">Select a verse</span>
                            <span class="empty-state-hint">Related passages will appear here</span>
                        </div>
                    </template>
                    <template x-if="crossRefs.length === 0 && currentReference">
                        <div class="empty-state">
                            <span class="empty-state-icon">üîó</span>
                            <span class="empty-state-title">No cross-references</span>
                            <span class="empty-state-hint">This verse has no linked references</span>
                        </div>
                    </template>
                    <ul class="crossref-list">
                        <template x-for="(ref, idx) in crossRefs" :key="'xref-' + idx">
                            <li class="crossref-item"
                                @mouseenter="previewVerse(ref.target_book + ' ' + ref.target_chapter + ':' + ref.target_verse, $event)"
                                @mouseleave="hidePreview()"
                            >
                                <span class="crossref-source" x-show="combinedPlanReading && ref._sourceRef" x-text="ref._sourceBook + ' ' + ref._sourceChapter + ':' + ref.source_verse + ' ‚Üí'"></span>
                                <a
                                    href="#"
                                    @click.prevent="loadReference(ref.target_book + ' ' + ref.target_chapter + ':' + ref.target_verse)"
                                    x-text="ref.target_book + ' ' + ref.target_chapter + ':' + ref.target_verse"
                                ></a>
                            </li>
                        </template>
                    </ul>
                </div>

            </div>
        </section>

        <!-- Word Details Panel (shows on word click) -->
        <aside class="panel panel-word" x-show="selectedWord" x-transition>
            <div class="panel-header">
                <h2>Word Details</h2>
                <button @click="selectedWord = null" class="btn-close">√ó</button>
            </div>
            <div class="panel-body" x-show="selectedWord">
                <!-- Show full word details when we have original language data -->
                <template x-if="selectedWord?.original || selectedWord?.strong_number">
                    <div>
                        <div class="word-header">
                            <span class="word-original" :class="selectedWord?.language" x-text="selectedWord?.original || selectedWord?.text"></span>
                            <span class="word-transliteration" x-text="selectedWord?.transliteration || '‚Äî'"></span>
                        </div>
                        <div class="word-strongs" x-show="selectedWord?.strong_number">
                            <span class="strong-badge" :class="selectedWord?.language" x-text="selectedWord?.strong_number"></span>
                            <span class="word-lang-label" x-text="selectedWord?.language === 'hebrew' ? 'Hebrew' : selectedWord?.language === 'greek' ? 'Greek' : ''"></span>
                        </div>
                        <div class="word-pronunciation" x-show="selectedWord?.pronunciation">
                            <em x-text="selectedWord?.pronunciation"></em>
                        </div>
                        <div class="word-definition">
                            <strong>Definition:</strong>
                            <p x-text="selectedWord?.definition || 'No definition available'"></p>
                        </div>
                    </div>
                </template>
                <!-- Show helpful message when clicking English words -->
                <template x-if="!selectedWord?.original && !selectedWord?.strong_number">
                    <div class="word-hint">
                        <div class="word-hint-title">
                            "<span x-text="selectedWord?.text"></span>"
                        </div>
                        <p x-text="selectedWord?.definition"></p>
                    </div>
                </template>
                <div class="word-extended" x-show="selectedWord?.extended_definition">
                    <strong>KJV Usage:</strong>
                    <p x-text="selectedWord?.extended_definition"></p>
                </div>
                <div class="word-derivation" x-show="selectedWord?.derivation">
                    <strong>Derivation:</strong>
                    <p x-text="selectedWord?.derivation"></p>
                </div>
                <div class="word-occurrences" x-show="selectedWord?.count > 0">
                    <h4>Appears <span x-text="selectedWord?.count"></span> times:</h4>
                    <ul class="occurrence-list">
                        <template x-for="(occ, occIdx) in (showAllOccurrences ? (selectedWord?.occurrences || []) : (selectedWord?.occurrences || []).slice(0, 10))" :key="'occ-' + occIdx">
                            <li>
                                <a
                                    href="#"
                                    @click.prevent="loadReference(occ.book + ' ' + occ.chapter + ':' + occ.verse)"
                                    x-text="occ.book + ' ' + occ.chapter + ':' + occ.verse"
                                ></a>
                            </li>
                        </template>
                        <li x-show="selectedWord?.count > 10 && !showAllOccurrences" class="more-occurrences">
                            <a href="#" @click.prevent="showAllOccurrences = true" class="show-more-link">
                                ...and <span x-text="selectedWord?.count - 10"></span> more
                            </a>
                        </li>
                        <li x-show="selectedWord?.count > 10 && showAllOccurrences" class="more-occurrences">
                            <a href="#" @click.prevent="showAllOccurrences = false" class="show-more-link">Show less</a>
                        </li>
                    </ul>
                </div>
            </div>
        </aside>
    </main>

    <!-- Search Modal -->
    <div class="modal-overlay" x-show="showSearch" x-transition @click.self="showSearch = false">
        <div class="modal search-modal">
            <div class="modal-header">
                <h2>Search</h2>
                <button @click="showSearch = false" class="btn-close">√ó</button>
            </div>
            <div class="modal-body">
                <div class="search-input-group">
                    <input
                        type="text"
                        x-model="searchQuery"
                        @input="handleSearchInput"
                        @keydown="handleSearchKeydown"
                        placeholder="Search Bible, commentary... (min 2 chars)"
                        class="input-search"
                        x-ref="searchInput"
                        autocomplete="off"
                    >
                    <select x-model="searchScope" @change="performSearch" class="select-scope">
                        <option value="all">All</option>
                        <option value="bible">Bible Text</option>
                        <option value="ot">Old Testament</option>
                        <option value="nt">New Testament</option>
                        <option :value="'book:' + currentBook" x-show="currentBook" x-text="'In ' + currentBook"></option>
                        <option value="commentary">Commentary</option>
                    </select>
                </div>

                <!-- Loading indicator -->
                <div x-show="searchLoading" class="search-loading">
                    <div class="loading-spinner"></div>
                    <span>Searching...</span>
                </div>

                <!-- No results message -->
                <div x-show="searchPerformed && !searchLoading && searchResults.length === 0" class="search-no-results">
                    <span class="empty-state-icon">üîç</span>
                    <span>No results found for "<span x-text="searchQuery"></span>"</span>
                    <span class="search-tip">Try different keywords or check spelling</span>
                </div>

                <!-- Strong's word info card -->
                <div x-show="searchWordInfo" class="strongs-word-card">
                    <div class="strongs-header">
                        <span class="strongs-number" x-text="searchWordInfo?.strong_number"></span>
                        <span class="strongs-original" x-text="searchWordInfo?.original"></span>
                        <span class="strongs-transliteration" x-text="'(' + (searchWordInfo?.transliteration || '') + ')'"></span>
                    </div>
                    <div class="strongs-definition" x-text="searchWordInfo?.definition"></div>
                </div>

                <!-- Results grouped by type -->
                <div class="search-results" x-show="searchResults.length > 0">
                    <!-- Bible Results -->
                    <template x-if="getGroupedResults().verse.length > 0">
                        <div class="results-group">
                            <div class="results-group-header">
                                <span class="group-icon">üìñ</span>
                                <span x-text="searchWordInfo ? 'Verses with this word' : 'Bible Text'"></span>
                                <span class="group-count" x-text="'(' + getGroupedResults().verse.length + ')'"></span>
                            </div>
                            <template x-for="(result, i) in getGroupedResults().verse" :key="'v' + i">
                                <div
                                    class="search-result"
                                    :class="{ 'selected': selectedResultIndex === searchResults.indexOf(result) }"
                                    @click="goToSearchResult(result)"
                                    @mouseenter="selectedResultIndex = searchResults.indexOf(result)"
                                >
                                    <div class="result-ref">
                                        <span x-text="result.book + ' ' + result.chapter + ':' + result.verse"></span>
                                        <span x-show="result.original_word" class="result-original-word" x-text="result.original_word"></span>
                                    </div>
                                    <div class="result-snippet" x-html="result.snippet"></div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- Commentary Results -->
                    <template x-if="getGroupedResults().commentary.length > 0">
                        <div class="results-group">
                            <div class="results-group-header">
                                <span class="group-icon">üìù</span>
                                Commentary
                                <span class="group-count" x-text="'(' + getGroupedResults().commentary.length + ')'"></span>
                            </div>
                            <template x-for="(result, i) in getGroupedResults().commentary" :key="'c' + i">
                                <div
                                    class="search-result"
                                    :class="{ 'selected': selectedResultIndex === searchResults.indexOf(result) }"
                                    @click="goToSearchResult(result)"
                                    @mouseenter="selectedResultIndex = searchResults.indexOf(result)"
                                >
                                    <div class="result-ref">
                                        <span x-text="result.book + ' ' + result.chapter"></span>
                                        <span class="result-source" x-text="'(' + result.source + ')'"></span>
                                    </div>
                                    <div class="result-snippet" x-html="result.snippet"></div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- Search tips -->
                <div x-show="!searchPerformed && searchQuery.length < 2" class="search-tips">
                    <p><strong>Search tips:</strong></p>
                    <ul>
                        <li>Use quotes for exact phrases: <code>"in the beginning"</code></li>
                        <li>Search Strong's numbers: <code>G26</code> or <code>H430</code></li>
                        <li>Use arrow keys to navigate results</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Verse Preview Tooltip -->
    <div
        x-show="versePreview.show"
        x-transition
        class="verse-preview-tooltip"
        :style="'top: ' + versePreview.y + 'px; left: ' + versePreview.x + 'px;'"
    >
        <div class="preview-ref" x-text="versePreview.reference"></div>
        <div class="preview-text" x-text="versePreview.text"></div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" x-show="showSettings" x-transition @click.self="showSettings = false">
        <div class="modal settings-modal">
            <div class="modal-header">
                <h2>Settings</h2>
                <button @click="showSettings = false" class="btn-close">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Settings Navigation -->
                <div class="settings-nav">
                    <button @click="settingsTab = 'account'" :class="{ active: settingsTab === 'account' }" class="settings-nav-btn">
                        Account
                        <span class="auth-badge" :class="authUser ? 'signed-in' : ''"></span>
                    </button>
                    <button @click="settingsTab = 'general'" :class="{ active: settingsTab === 'general' }" class="settings-nav-btn">
                        General
                    </button>
                    <button @click="settingsTab = 'tags'" :class="{ active: settingsTab === 'tags' }" class="settings-nav-btn">
                        Tags
                        <span class="tag-count-badge" x-show="tags.length > 0" x-text="tags.length"></span>
                    </button>
                    <button @click="settingsTab = 'offline'" :class="{ active: settingsTab === 'offline' }" class="settings-nav-btn">
                        Offline
                        <span class="offline-badge" :class="isOnline ? 'online' : 'offline'"></span>
                    </button>
                </div>

                <!-- Account Settings Tab -->
                <div class="settings-content" x-show="settingsTab === 'account'">
                    <!-- Signed In View -->
                    <template x-if="authUser">
                        <div class="auth-signed-in">
                            <div class="auth-user-info">
                                <div class="auth-avatar">
                                    <span x-text="authUser.email?.charAt(0).toUpperCase()"></span>
                                </div>
                                <div class="auth-details">
                                    <div class="auth-email" x-text="authUser.email"></div>
                                    <div class="auth-status">Signed in</div>
                                </div>
                            </div>
                            <div class="auth-notes-info">
                                <p>Your notes are synced across devices.</p>
                                <p class="auth-notes-count" x-show="notes.length > 0" x-text="notes.length + ' note' + (notes.length === 1 ? '' : 's') + ' saved'"></p>
                            </div>
                            <div class="auth-actions">
                                <button @click="handleSignOut()" class="btn-secondary" :disabled="authLoading">
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </template>

                    <!-- Signed Out View -->
                    <template x-if="!authUser">
                        <div class="auth-signed-out">
                            <div class="auth-intro">
                                <h4>Sign in to sync your notes</h4>
                                <p>Create an account to save your notes across devices. Or continue as a guest - your notes will be saved locally.</p>
                            </div>

                            <!-- Auth Form -->
                            <div class="auth-form">
                                <div class="auth-tabs">
                                    <button @click="authMode = 'signin'" :class="{ active: authMode === 'signin' }" class="auth-tab-btn">Sign In</button>
                                    <button @click="authMode = 'signup'" :class="{ active: authMode === 'signup' }" class="auth-tab-btn">Sign Up</button>
                                </div>

                                <div class="auth-error" x-show="authError" x-text="authError"></div>
                                <div class="auth-success" x-show="authSuccess" x-text="authSuccess"></div>

                                <div class="auth-fields">
                                    <input
                                        type="email"
                                        x-model="authEmail"
                                        placeholder="Email"
                                        class="auth-input"
                                        @keydown.enter="authMode === 'signin' ? handleSignIn() : handleSignUp()"
                                    >
                                    <input
                                        type="password"
                                        x-model="authPassword"
                                        placeholder="Password"
                                        class="auth-input"
                                        @keydown.enter="authMode === 'signin' ? handleSignIn() : handleSignUp()"
                                    >
                                    <input
                                        x-show="authMode === 'signup'"
                                        type="password"
                                        x-model="authPasswordConfirm"
                                        placeholder="Confirm Password"
                                        class="auth-input"
                                        @keydown.enter="handleSignUp()"
                                    >
                                </div>

                                <div class="auth-actions">
                                    <button
                                        x-show="authMode === 'signin'"
                                        @click="handleSignIn()"
                                        class="btn-primary"
                                        :disabled="authLoading || !authEmail || !authPassword"
                                    >
                                        <span x-show="!authLoading">Sign In</span>
                                        <span x-show="authLoading">Signing in...</span>
                                    </button>
                                    <button
                                        x-show="authMode === 'signup'"
                                        @click="handleSignUp()"
                                        class="btn-primary"
                                        :disabled="authLoading || !authEmail || !authPassword || authPassword !== authPasswordConfirm"
                                    >
                                        <span x-show="!authLoading">Create Account</span>
                                        <span x-show="authLoading">Creating account...</span>
                                    </button>
                                </div>

                                <div class="auth-links">
                                    <button @click="handleForgotPassword()" class="auth-link" x-show="authMode === 'signin'">
                                        Forgot password?
                                    </button>
                                </div>
                            </div>

                            <div class="auth-guest-info">
                                <p><strong>Guest mode:</strong> Notes are saved in your browser only and won't sync across devices.</p>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- General Settings Tab -->
                <div class="settings-content" x-show="settingsTab === 'general'">
                    <div class="settings-section">
                        <h4>Appearance</h4>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Dark Mode</div>
                                <div class="setting-description">Use dark theme for comfortable reading</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" x-model="darkMode" @change="saveDarkMode()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4>Bible Translation</h4>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Default Translation</div>
                                <div class="setting-description">Used when opening the app</div>
                            </div>
                            <select x-model="defaultTranslation" @change="saveDefaultTranslation()" class="setting-select">
                                <option value="BSB">BSB - Berean Standard</option>
                                <option value="WEB">WEB - World English</option>
                                <option value="KJV">KJV - King James</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4>Reading</h4>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Show Interlinear by Default</div>
                                <div class="setting-description">Display Hebrew/Greek text automatically</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" x-model="defaultShowInterlinear" @change="saveInterlinearPref()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Red Letter</div>
                                <div class="setting-description">Highlight words of God (OT) and Jesus (NT) in red</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" x-model="showRedLetter" @change="saveRedLetterPref()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4>Book Genre Colors</h4>
                        <p class="settings-description">Customize colors for book categories in the book picker.</p>
                        <div class="genre-colors-grid">
                            <template x-for="(color, genre) in genreColors" :key="genre">
                                <div class="genre-color-row">
                                    <div class="genre-color-swatch" :style="'background-color: ' + color"></div>
                                    <label class="genre-color-label" x-text="genre.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())"></label>
                                    <input
                                        type="color"
                                        :value="color"
                                        @change="genreColors[genre] = $event.target.value; saveGenreColor(genre)"
                                        class="genre-color-input"
                                    >
                                </div>
                            </template>
                        </div>
                        <button @click="resetGenreColors()" class="btn-reset-colors">Reset to Defaults</button>
                    </div>
                </div>

                <!-- Tags Settings Tab -->
                <div class="settings-content" x-show="settingsTab === 'tags'">
                    <div class="settings-section">
                        <h4>Your Tags</h4>
                        <p class="settings-description">Create custom tags with colors to organize your notes.</p>

                        <!-- Create new tag form -->
                        <div class="tag-create-form">
                            <input
                                type="text"
                                x-model="newTagName"
                                placeholder="Tag name"
                                class="tag-name-input"
                                @keydown.enter="createTag()"
                                maxlength="30"
                            >
                            <div class="tag-color-picker">
                                <template x-for="color in tagColors" :key="color">
                                    <button
                                        type="button"
                                        class="color-swatch"
                                        :class="{ selected: newTagColor === color }"
                                        :style="'background-color: ' + color"
                                        @click="newTagColor = color"
                                        :title="color"
                                    ></button>
                                </template>
                            </div>
                            <button @click="createTag()" class="btn-create-tag" :disabled="!newTagName.trim()">
                                Add Tag
                            </button>
                        </div>

                        <!-- Existing tags list -->
                        <div class="tags-list" x-show="tags.length > 0">
                            <template x-for="tag in tags" :key="tag.id">
                                <div class="tag-item" :class="{ editing: editingTag?.id === tag.id }">
                                    <template x-if="editingTag?.id !== tag.id">
                                        <div class="tag-display">
                                            <span class="tag-color-dot" :style="'background-color: ' + tag.color"></span>
                                            <span class="tag-name" x-text="tag.name"></span>
                                            <div class="tag-actions">
                                                <button @click="editingTag = {...tag}" class="btn-edit-tag" title="Edit">Edit</button>
                                                <button @click="deleteTag(tag.id)" class="btn-delete-tag" title="Delete">√ó</button>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-if="editingTag?.id === tag.id">
                                        <div class="tag-edit-form">
                                            <input
                                                type="text"
                                                x-model="editingTag.name"
                                                class="tag-name-input"
                                                maxlength="30"
                                            >
                                            <div class="tag-color-picker compact">
                                                <template x-for="color in tagColors" :key="'edit-' + color">
                                                    <button
                                                        type="button"
                                                        class="color-swatch small"
                                                        :class="{ selected: editingTag.color === color }"
                                                        :style="'background-color: ' + color"
                                                        @click="editingTag.color = color"
                                                    ></button>
                                                </template>
                                            </div>
                                            <div class="tag-edit-actions">
                                                <button @click="tag.name = editingTag.name; tag.color = editingTag.color; updateTag(tag)" class="btn-save-tag">Save</button>
                                                <button @click="editingTag = null" class="btn-cancel-tag">Cancel</button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>

                        <!-- Empty state -->
                        <div class="tags-empty" x-show="tags.length === 0">
                            <p>No tags yet. Create your first tag above!</p>
                            <p class="tags-hint">Tags help you categorize notes by theme (e.g., "Faith", "Prayer", "Prophecy")</p>
                        </div>
                    </div>
                </div>

                <!-- Offline Settings Tab -->
                <div class="settings-content" x-show="settingsTab === 'offline'">
                    <!-- Offline Availability Section -->
                    <div class="offline-availability-header">Offline Availability</div>
                    <div class="offline-status-bar">
                        <span class="status-indicator" :class="isOnline ? 'online' : 'offline'"></span>
                        <span class="status-text" x-text="forcedOffline ? 'Forced Offline' : (isOnline ? 'Online' : 'Offline')"></span>
                        <button @click="toggleForcedOffline()" class="btn-offline-toggle" :class="{ active: forcedOffline }">
                            <span x-text="forcedOffline ? 'Go Online' : 'Go Offline'"></span>
                        </button>
                    </div>

                    <!-- Cache Stats Box - More Prominent -->
                    <div class="cache-stats-box">
                        <div class="cache-stats-header">Cached Data</div>
                        <div class="cache-stats-numbers">
                            <div class="cache-stat">
                                <span class="cache-stat-value" x-text="offlineStats.chapters"></span>
                                <span class="cache-stat-label">Chapters</span>
                            </div>
                            <div class="cache-stat">
                                <span class="cache-stat-value" x-text="offlineStats.verses.toLocaleString()"></span>
                                <span class="cache-stat-label">Verses</span>
                            </div>
                            <div class="cache-stat">
                                <span class="cache-stat-value" x-text="formatStorageSize(offlineStats.estimatedSize)"></span>
                                <span class="cache-stat-label">Storage</span>
                            </div>
                        </div>
                    </div>

                    <!-- Auto-Cache Toggle -->
                    <div class="auto-cache-section">
                        <div class="setting-row compact">
                            <div class="setting-info">
                                <div class="setting-label">Auto-cache browsed chapters</div>
                                <div class="setting-description">Automatically save chapters you read for offline use</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" x-model="autoCacheEnabled" @change="saveAutoCachePref()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Bulk Download Section Header -->
                    <div class="download-section-title">Download for Offline</div>

                    <!-- Translations -->
                    <div class="download-section">
                        <div class="download-section-header">Translations</div>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.translations.BSB">
                            <span>BSB - Berean Standard Bible</span>
                        </label>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.translations.WEB">
                            <span>WEB - World English Bible</span>
                        </label>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.translations.KJV">
                            <span>KJV - King James Version</span>
                        </label>
                    </div>

                    <!-- Commentaries -->
                    <div class="download-section">
                        <div class="download-section-header">Commentaries</div>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.commentaryMH">
                            <span>Matthew Henry Commentary</span>
                        </label>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.commentaryJG">
                            <span>John Gill Commentary</span>
                        </label>
                    </div>

                    <!-- Devotionals -->
                    <div class="download-section">
                        <div class="download-section-header">Devotionals</div>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.devotionalSpurgeon">
                            <span>Spurgeon Morning & Evening</span>
                        </label>
                    </div>

                    <!-- Resources -->
                    <div class="download-section">
                        <div class="download-section-header">Resources</div>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.lexicon">
                            <span>Strong's Lexicon</span>
                        </label>
                        <label class="download-option">
                            <input type="checkbox" x-model="downloadSelections.crossRefs">
                            <span>Cross-References</span>
                        </label>
                    </div>

                    <!-- Download Progress -->
                    <div class="download-progress" x-show="downloadProgress.active">
                        <div class="progress-header">
                            <span x-text="downloadProgress.label"></span>
                            <span x-text="downloadProgress.percent + '%'"></span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" :style="'width: ' + downloadProgress.percent + '%'"></div>
                        </div>
                        <div class="progress-status" x-text="downloadProgress.status"></div>
                    </div>

                    <!-- Actions -->
                    <div class="download-actions">
                        <button @click="startOfflineDownload()" class="btn-primary" :disabled="downloadProgress.active || !hasDownloadSelections()">
                            Download Selected
                        </button>
                        <button @click="refreshOfflineData()" class="btn-secondary" :disabled="downloadProgress.active">
                            Refresh
                        </button>
                        <button @click="clearOfflineData()" class="btn-danger" :disabled="downloadProgress.active">
                            Clear All
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Guide Modal -->
    <div class="modal-overlay" x-show="showGuide" x-transition @click.self="showGuide = false">
        <div class="modal guide-modal">
            <div class="modal-header">
                <h2>Guide</h2>
                <button @click="showGuide = false" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="guide-section">
                    <h4>Tips</h4>
                    <ul class="tips-list">
                        <li>Click any verse to see commentary and cross-references</li>
                        <li>Click any word (in BSB) to see Hebrew/Greek details</li>
                        <li>Enable "Original Language" in settings to see interlinear text</li>
                        <li>Red letter mode highlights words of God (OT) and Jesus (NT)</li>
                        <li>Use reading plans for structured daily Bible reading</li>
                        <li>Create notes on verses - tag them for easy organization</li>
                        <li>Sign in to sync notes and progress across devices</li>
                        <li>URLs update as you navigate - share or bookmark any verse</li>
                        <li>Use the book picker to browse by genre-colored categories</li>
                        <li>Download books for offline reading in Settings > Offline</li>
                    </ul>
                </div>

                <!-- Keyboard shortcuts (desktop only) -->
                <div class="guide-section shortcuts-desktop-only">
                    <h4>Keyboard Shortcuts</h4>
                    <div class="shortcuts-list">
                        <div class="shortcut-item">
                            <span class="shortcut-keys"><kbd>&larr;</kbd> <kbd>&rarr;</kbd></span>
                            <span class="shortcut-desc">Previous / Next chapter</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-keys"><kbd>&uarr;</kbd> <kbd>&darr;</kbd></span>
                            <span class="shortcut-desc">Previous / Next verse</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-keys"><kbd>G</kbd></span>
                            <span class="shortcut-desc">Go to reference input</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-keys"><kbd>/</kbd></span>
                            <span class="shortcut-desc">Open search</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-keys"><kbd>C</kbd></span>
                            <span class="shortcut-desc">Copy current verse</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-keys"><kbd>D</kbd></span>
                            <span class="shortcut-desc">Toggle dark mode</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-keys"><kbd>Esc</kbd></span>
                            <span class="shortcut-desc">Close panels / modals</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal-overlay" x-show="showAbout" x-transition @click.self="showAbout = false">
        <div class="modal about-modal">
            <div class="modal-header">
                <h2>About</h2>
                <button @click="showAbout = false" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="about-section">
                    <h4>In the Word</h4>
                    <p class="about-text">
                        A free, open-source Bible study tool built to help you dig deeper into Scripture.
                        Cross-reference commentaries, original language insights, and your personal notes
                        all in one place.
                    </p>
                </div>

                <div class="about-section">
                    <h4>Builder's Note</h4>
                    <p class="about-text">
                        This project was born out of a desire to create a simple, focused Bible reading experience
                        with acess to as much cross refernce and commentary material as possible. 
                    </p>
                </div>

                <div class="about-section">
                    <h4>Feedback</h4>
                    <p class="about-text">Found a bug, accuracy issue, or have a feature idea?</p>
                    <template x-if="authUser">
                        <button @click="openFeedbackFromAbout()" class="btn-secondary">Submit Feedback</button>
                    </template>
                    <template x-if="!authUser">
                        <p class="about-text-muted">Sign in to submit feedback.</p>
                    </template>
                </div>

                <div class="about-section about-links">
                    <h4>Links</h4>
                    <div class="about-link-list">
                        <a href="https://github.com" target="_blank" rel="noopener" class="about-link">GitHub</a>
                    </div>
                </div>

                <div class="about-footer">
                    <span class="about-version">Version 0.1-alpha</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Jesus Modal -->
    <div class="modal-overlay" x-show="showShareJesus" x-transition @click.self="showShareJesus = false">
        <div class="modal share-jesus-modal">
            <div class="modal-header">
                <h2>Share Jesus Without Fear</h2>
                <button @click="showShareJesus = false" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="share-jesus-section share-jesus-about">
                    <p class="share-jesus-description">
                        Share Jesus Without Fear is a simple, conversational approach to sharing the Gospel.
                        You don't need to have all the answers‚Äîjust ask questions, let them read Scripture aloud,
                        and ask "What does this say to you?" The Holy Spirit does the work through God's Word.
                        Your job is simply to be obedient and share.
                    </p>
                </div>

                <div class="share-jesus-section">
                    <h4>5 Opening Questions</h4>
                    <ol class="share-jesus-list">
                        <li>Do you have any kind of spiritual beliefs?</li>
                        <li>To you, who is Jesus Christ?</li>
                        <li>Do you believe in heaven or hell?</li>
                        <li>If you died right now, where would you go? If heaven, why?</li>
                        <li>If what you believe is not true, would you want to know?</li>
                    </ol>
                </div>

                <div class="share-jesus-section">
                    <h4>7 Verses</h4>
                    <p class="share-jesus-intro">Have them read each verse aloud, then ask: "What does this say to you?"</p>
                    <button @click="startShareJesusVerses()" class="btn-primary btn-start-verses">
                        Go to Verses ‚Üí
                    </button>
                    <div class="share-jesus-verses-list">
                        <div class="verse-list-item"><span class="verse-num">1.</span> Romans 3:23 <span class="verse-theme">‚Äî All have sinned</span></div>
                        <div class="verse-list-item"><span class="verse-num">2.</span> Romans 6:23 <span class="verse-theme">‚Äî Wages of sin / Gift of God</span></div>
                        <div class="verse-list-item"><span class="verse-num">3.</span> John 3:3 <span class="verse-theme">‚Äî Must be born again</span></div>
                        <div class="verse-list-item"><span class="verse-num">4.</span> John 14:6 <span class="verse-theme">‚Äî Jesus is the only way</span></div>
                        <div class="verse-list-item"><span class="verse-num">5.</span> Romans 10:9-11 <span class="verse-theme">‚Äî Confess and believe</span></div>
                        <div class="verse-list-item"><span class="verse-num">6.</span> 2 Corinthians 5:15 <span class="verse-theme">‚Äî Live for Him</span></div>
                        <div class="verse-list-item"><span class="verse-num">7.</span> Revelation 3:20 <span class="verse-theme">‚Äî Jesus knocks</span></div>
                    </div>
                </div>

                <div class="share-jesus-section">
                    <h4>5 Final Questions</h4>
                    <ol class="share-jesus-list">
                        <li>Are you a sinner?</li>
                        <li>Do you want forgiveness of sins?</li>
                        <li>Do you believe Jesus died on the cross and rose again?</li>
                        <li>Are you willing to surrender your life to Jesus Christ?</li>
                        <li>Are you ready to invite Jesus into your life and heart?</li>
                    </ol>
                </div>

                <div class="share-jesus-section">
                    <h4>The Prayer</h4>
                    <p class="share-jesus-intro">If they answer yes to all five questions, lead them in this prayer:</p>
                    <div class="share-jesus-prayer">
                        <p>"Dear God, I am a sinner and need forgiveness. I believe that Jesus Christ shed His precious blood and died for my sin. I am willing to turn from sin. I now invite Christ to come into my heart and life as my personal Savior."</p>
                    </div>
                </div>

                <div class="share-jesus-section share-jesus-success">
                    <h4>If They Say Yes</h4>
                    <p class="share-jesus-encouragement">
                        <strong>Celebrate with them!</strong> They have just made the most important decision of their life.
                        Help them understand what happened and take these next steps:
                    </p>
                    <ol class="share-jesus-next-steps">
                        <li><strong>Read the Bible daily</strong> ‚Äî Start with the Gospel of John to learn more about Jesus.</li>
                        <li><strong>Pray</strong> ‚Äî Talk to God daily. He wants to hear from you.</li>
                        <li><strong>Find a Bible-believing church</strong> ‚Äî Connect with other believers who can encourage and teach you.</li>
                        <li><strong>Tell someone</strong> ‚Äî Share your decision with a friend or family member.</li>
                        <li><strong>Get baptized</strong> ‚Äî This is your public declaration of faith in Christ.</li>
                    </ol>
                    <p class="share-jesus-encouragement">
                        Stay connected with them! Offer to read the Bible together, invite them to church, and be available as they grow in their new faith.
                    </p>
                </div>

                <div class="share-jesus-section share-jesus-rejection">
                    <h4>If They Say No</h4>
                    <p class="share-jesus-encouragement">
                        <strong>You did not fail.</strong> Remember: they are not rejecting you‚Äîthey are rejecting Jesus and God's Word.
                        Therefore you did not fail in your obedience.
                    </p>
                    <p class="share-jesus-encouragement">
                        Research shows it takes an average of 7.6 times hearing the gospel before someone responds.
                        You never know if you're the first person to share, or if you're planting that 6th or 7th seed. Either way, you were faithful.
                    </p>
                    <p class="share-jesus-encouragement">
                        As Bill Fay says: <em>"If you get a 'no' that sticks, it's not your problem‚Äîit's God's."</em>
                    </p>
                    <p class="share-jesus-encouragement">
                        Simply ask: <em>"Would it be okay if I prayed for you?"</em> Most people will say yes. And keep loving them‚Äîyour relationship doesn't end here.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Single Verse View (reusable for Share Jesus, verse of the day, etc.) -->
    <div class="single-verse-overlay" x-show="singleVerseMode" x-transition>
        <div class="single-verse-header">
            <button @click="exitSingleVerseMode()" class="btn-exit-single-verse">‚úï Exit</button>
            <div class="single-verse-progress" x-show="singleVerseList.length > 1">
                <span x-text="singleVerseIndex + ' of ' + singleVerseList.length"></span>
            </div>
            <div x-show="singleVerseList.length <= 1"></div>
            <button @click="nextSingleVerse()" class="btn-next-single-verse" x-show="singleVerseIndex < singleVerseList.length">
                Next ‚Üí
            </button>
            <button @click="finishSingleVerseMode()" class="btn-finish-single-verse" x-show="singleVerseIndex >= singleVerseList.length">
                Done
            </button>
        </div>
        <div class="single-verse-body">
            <div class="single-verse-content">
                <div class="single-verse-ref" x-text="getCurrentSingleVerse().ref"></div>
                <div class="single-verse-loading" x-show="singleVerseLoading">
                    <div class="loading-spinner"></div>
                </div>
                <div class="single-verse-text" x-show="!singleVerseLoading" x-html="singleVerseText"></div>
            </div>
            <!-- Prompt below the verse -->
            <div class="single-verse-prompt" x-show="singleVersePrompt">
                <p class="single-verse-prompt-text">What does this say to you?</p>
            </div>
            <!-- Link to view full passage -->
            <button @click="viewFullPassageFromSingleVerse()" class="btn-view-full-passage">
                View full passage ‚Üí
            </button>
        </div>
        <div class="single-verse-nav" x-show="singleVerseList.length > 1">
            <button @click="prevSingleVerse()" class="btn-prev-single-verse" :disabled="singleVerseIndex <= 1">
                ‚Üê Previous
            </button>
            <div class="single-verse-dots">
                <template x-for="i in singleVerseList.length" :key="i">
                    <span class="single-verse-dot" :class="{ 'active': i === singleVerseIndex }" @click="goToSingleVerse(i)"></span>
                </template>
            </div>
            <button @click="nextSingleVerse()" class="btn-next-single-verse" x-show="singleVerseIndex < singleVerseList.length">
                Next ‚Üí
            </button>
            <button @click="finishSingleVerseMode()" class="btn-finish-single-verse" x-show="singleVerseIndex >= singleVerseList.length">
                Done
            </button>
        </div>
    </div>

    <!-- Feedback Modal (standalone) -->
    <div class="modal-overlay" x-show="showFeedback" x-transition @click.self="showFeedback = false">
        <div class="modal feedback-modal">
            <div class="modal-header">
                <h2>Submit Feedback</h2>
                <button @click="showFeedback = false" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <p class="feedback-intro">Help improve In the Word by reporting bugs, accuracy issues, or suggesting features.</p>

                <!-- Success message -->
                <div class="feedback-success" x-show="feedbackSuccess">
                    <span>Thank you! Your feedback has been submitted.</span>
                    <button @click="resetFeedbackForm()" class="btn-text">Submit another</button>
                </div>

                <!-- Error message -->
                <div class="feedback-error" x-show="feedbackError" x-text="feedbackError"></div>

                <!-- Feedback form -->
                <form x-show="!feedbackSuccess" @submit.prevent="submitFeedback()" class="feedback-form">
                    <!-- Category selection -->
                    <div class="feedback-field">
                        <label>Category</label>
                        <div class="feedback-category-btns">
                            <button type="button" @click="feedbackCategory = 'bug'" :class="{ active: feedbackCategory === 'bug' }" class="category-btn">
                                Bug / Issue
                            </button>
                            <button type="button" @click="feedbackCategory = 'accuracy'" :class="{ active: feedbackCategory === 'accuracy' }" class="category-btn">
                                Accuracy
                            </button>
                            <button type="button" @click="feedbackCategory = 'feature'" :class="{ active: feedbackCategory === 'feature' }" class="category-btn">
                                Feature Request
                            </button>
                        </div>
                    </div>

                    <!-- Accuracy-specific fields -->
                    <template x-if="feedbackCategory === 'accuracy'">
                        <div class="accuracy-fields">
                            <div class="feedback-field">
                                <label>Verse Reference</label>
                                <input type="text" x-model="feedbackVerseRef" placeholder="e.g., John 3:16" class="feedback-input">
                            </div>
                            <div class="feedback-field">
                                <label>Translation</label>
                                <select x-model="feedbackTranslation" class="feedback-select">
                                    <option value="">Select translation</option>
                                    <option value="BSB">BSB</option>
                                    <option value="KJV">KJV</option>
                                    <option value="WEB">WEB</option>
                                </select>
                            </div>
                            <div class="feedback-field">
                                <label>Issue Type</label>
                                <select x-model="feedbackAccuracyType" class="feedback-select">
                                    <option value="">Select type</option>
                                    <option value="text">Bible Text</option>
                                    <option value="original_lang">Original Language / Greek / Hebrew</option>
                                    <option value="commentary">Commentary</option>
                                    <option value="cross_ref">Cross References</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </template>

                    <!-- Description (always shown) -->
                    <div class="feedback-field">
                        <label x-text="feedbackCategory === 'accuracy' ? 'Describe the issue' : (feedbackCategory === 'feature' ? 'Describe your feature idea' : 'Describe the bug or issue')"></label>
                        <textarea x-model="feedbackDescription" :placeholder="feedbackCategory === 'accuracy' ? 'What is incorrect and what should it be?' : (feedbackCategory === 'feature' ? 'What would you like to see added?' : 'What happened? What did you expect?')" class="feedback-textarea" rows="4"></textarea>
                    </div>

                    <!-- Screenshot (for bugs only) -->
                    <template x-if="feedbackCategory === 'bug'">
                        <div class="feedback-field">
                            <label>Screenshot (optional)</label>
                            <input type="file" @change="handleScreenshotSelect($event)" accept="image/*" class="feedback-file-input">
                            <div x-show="feedbackScreenshotPreview" class="screenshot-preview">
                                <img :src="feedbackScreenshotPreview" alt="Screenshot preview">
                                <button type="button" @click="clearScreenshot()" class="btn-remove-screenshot">&times;</button>
                            </div>
                        </div>
                    </template>

                    <!-- Submit button -->
                    <div class="feedback-actions">
                        <button type="submit" class="btn-primary" :disabled="feedbackSubmitting || !feedbackDescription.trim()">
                            <span x-show="!feedbackSubmitting">Submit Feedback</span>
                            <span x-show="feedbackSubmitting">Submitting...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Reading Plan Modal -->
    <div class="modal-overlay" x-show="showReadingPlan" x-transition @click.self="showReadingPlan = false">
        <div class="modal reading-plan-modal">
            <div class="modal-header">
                <h2>Reading Plans</h2>
                <button @click="showReadingPlan = false" class="btn-close">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Loading state -->
                <div x-show="planLoading" class="plan-loading">
                    <div class="loading-spinner"></div>
                    <span>Loading plans...</span>
                </div>

                <!-- No active plan - show plan selection -->
                <template x-if="!planLoading && !currentPlan">
                    <div class="plan-selection">
                        <p class="plan-intro">Choose a reading plan to start your Bible reading journey.</p>
                        <div class="plan-list">
                            <template x-for="plan in readingPlans" :key="plan.id">
                                <div class="plan-card">
                                    <div class="plan-card-header">
                                        <h3 x-text="plan.name"></h3>
                                        <span class="plan-duration" x-text="plan.duration_days + ' days'"></span>
                                    </div>
                                    <p class="plan-description" x-text="plan.description"></p>
                                    <div class="plan-tracks">
                                        <template x-for="track in plan.tracks" :key="track.id">
                                            <span class="plan-track-badge" x-text="track.name"></span>
                                        </template>
                                    </div>
                                    <button @click="promptStartPlan(plan.id)" class="btn-start-plan">Start Plan</button>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>

                <!-- Start date picker modal -->
                <template x-if="showPlanStartPicker && !showCatchUpPrompt">
                    <div class="plan-start-picker">
                        <h3>When would you like to start?</h3>
                        <p class="picker-description">Choose a start date for your reading plan. For annual plans, many prefer starting January 1st.</p>
                        <div class="date-picker-options">
                            <button @click="planStartDate = new Date().toISOString().split('T')[0]; confirmStartPlan()" class="btn-date-option">
                                Today
                            </button>
                            <button @click="selectJanuaryFirst()" class="btn-date-option btn-date-jan1">
                                <span class="date-option-main">January 1st, <span x-text="new Date().getFullYear()"></span></span>
                                <span class="date-option-hint">Set start date to beginning of year</span>
                            </button>
                        </div>
                        <div class="custom-date-picker">
                            <label>Or choose a custom date:</label>
                            <input type="date" x-model="planStartDate" class="input-date-picker">
                        </div>
                        <div class="date-picker-actions">
                            <button @click="cancelStartPlan()" class="btn-secondary">Cancel</button>
                            <button @click="checkForCatchUp()" class="btn-primary" :disabled="!planStartDate">Start Plan</button>
                        </div>
                    </div>
                </template>

                <!-- Catch-up confirmation modal -->
                <template x-if="showCatchUpPrompt">
                    <div class="plan-start-picker">
                        <h3>Catch up on past days?</h3>
                        <p class="picker-description">
                            Your start date is <strong x-text="formatStartDate(planStartDate)"></strong>, which was
                            <strong x-text="getDaysElapsed()"></strong> days ago.
                        </p>
                        <p class="picker-description">
                            Would you like to mark all days up to today as completed?
                        </p>
                        <div class="catch-up-options">
                            <button @click="confirmStartPlanWithCatchUp(true)" class="btn-primary">
                                Yes, mark <span x-text="getDaysElapsed()"></span> days complete
                            </button>
                            <button @click="confirmStartPlanWithCatchUp(false)" class="btn-secondary">
                                No, start fresh from day 1
                            </button>
                        </div>
                        <div class="date-picker-actions">
                            <button @click="showCatchUpPrompt = false" class="btn-secondary">Back</button>
                        </div>
                    </div>
                </template>

                <!-- Active plan view -->
                <template x-if="!planLoading && currentPlan">
                    <div class="plan-active">
                        <!-- Completion celebration banner -->
                        <div class="plan-complete-banner" x-show="isPlanComplete()" x-transition>
                            <span class="complete-icon">üéâ</span>
                            <span class="complete-text">Congratulations! You've completed the reading plan!</span>
                        </div>

                        <!-- Plan header with progress -->
                        <div class="plan-header-info">
                            <div class="plan-name-row">
                                <h3 x-text="currentPlan.name"></h3>
                                <span class="plan-complete-badge" x-show="isPlanComplete()">Complete</span>
                                <button @click="resetPlan(currentPlan.id)" class="btn-reset-plan" title="Reset plan">Reset</button>
                            </div>
                            <div class="plan-progress-bar" :class="{ 'complete': isPlanComplete() }">
                                <div class="plan-progress-fill" :style="'width: ' + getPlanProgressPercent() + '%'"></div>
                            </div>
                            <div class="plan-progress-text">
                                <span x-text="getCompletedDaysCount() + ' of ' + currentPlan.duration_days + ' days completed'"></span>
                                <span x-text="'(' + getPlanProgressPercent() + '%)'"></span>
                            </div>
                            <div class="plan-start-date" x-show="formatPlanDate(currentPlan.id)">
                                Started: <span x-text="formatPlanDate(currentPlan.id)"></span>
                            </div>
                        </div>

                        <!-- Day navigation -->
                        <div class="plan-day-nav">
                            <button @click="goToPlanDay(planDay - 1)" class="btn-day-nav" :disabled="planDay <= 1">‚Üê Prev</button>
                            <div class="plan-day-selector">
                                <span>Day</span>
                                <input type="number" x-model.number="planDay" min="1" :max="currentPlan.duration_days" class="input-day-num" @change="goToPlanDay(planDay)">
                                <span x-text="'of ' + currentPlan.duration_days"></span>
                            </div>
                            <button @click="goToPlanDay(planDay + 1)" class="btn-day-nav" :disabled="planDay >= currentPlan.duration_days">Next ‚Üí</button>
                        </div>

                        <!-- Today button -->
                        <button @click="goToTodaysPlanDay()" class="btn-go-today" x-show="getTodaysPlanDay(currentPlan.id) !== planDay">
                            Go to Today (Day <span x-text="getTodaysPlanDay(currentPlan.id)"></span>)
                        </button>

                        <!-- Day's readings -->
                        <div class="plan-day-readings" x-show="getPlanDayReadings(planDay)">
                            <div class="day-header">
                                <span class="day-label" x-text="'Day ' + planDay"></span>
                                <label class="day-complete-toggle">
                                    <input type="checkbox" :checked="isDayCompleted(planDay)" @change="toggleDayComplete(planDay)">
                                    <span x-text="isDayCompleted(planDay) ? 'Completed' : 'Mark complete'"></span>
                                </label>
                            </div>

                            <div class="reading-list">
                                <!-- Main/Chronological reading -->
                                <div class="reading-item" x-show="getPlanDayReadings(planDay)?.chronological">
                                    <span class="reading-type">Main Reading</span>
                                    <button class="reading-ref" @click="goToPlanPassage(getPlanDayReadings(planDay)?.chronological)" x-text="getPlanDayReadings(planDay)?.chronological"></button>
                                </div>

                                <!-- Psalms -->
                                <div class="reading-item" x-show="getPlanDayReadings(planDay)?.psalms">
                                    <span class="reading-type">Psalms</span>
                                    <button class="reading-ref" @click="goToPlanPassage(getPlanDayReadings(planDay)?.psalms)" x-text="getPlanDayReadings(planDay)?.psalms"></button>
                                </div>

                                <!-- Proverbs -->
                                <div class="reading-item" x-show="getPlanDayReadings(planDay)?.proverbs">
                                    <span class="reading-type">Proverbs</span>
                                    <button class="reading-ref" @click="goToPlanPassage(getPlanDayReadings(planDay)?.proverbs)" x-text="getPlanDayReadings(planDay)?.proverbs"></button>
                                </div>
                            </div>

                            <!-- Start combined reading button -->
                            <button @click="startPlanReading()" class="btn-start-reading">
                                Read All Together
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Plan Reading Mode Overlay (shows all passages combined) -->
    <div class="plan-reading-overlay" x-show="planReadingMode" x-transition>
        <div class="plan-reading-header">
            <button @click="exitPlanReadingMode()" class="btn-exit-plan-reading">‚Üê Back</button>
            <div class="plan-reading-title">
                <span x-text="currentPlan?.name"></span>
                <span class="plan-reading-day" x-text="'Day ' + planDay"></span>
            </div>
            <button @click="markPlanDayAndContinue()" class="btn-mark-complete">
                <span x-text="isDayCompleted(planDay) ? 'Next Day ‚Üí' : 'Complete & Next ‚Üí'"></span>
            </button>
        </div>
        <div class="plan-reading-content">
            <template x-for="(reading, idx) in planReadings" :key="'pr-' + idx">
                <div class="plan-reading-section">
                    <div class="reading-section-header">
                        <span class="reading-section-label" x-text="reading.label"></span>
                        <span class="reading-section-ref" x-text="reading.reference"></span>
                    </div>
                    <div class="reading-section-verses">
                        <template x-for="(verse, vIdx) in reading.verses" :key="'prv-' + idx + '-' + vIdx">
                            <span class="plan-verse">
                                <span x-show="verse._chapterStart" class="chapter-divider" x-text="verse._chapterRef"></span>
                                <sup class="verse-num" x-text="verse.verse"></sup>
                                <span x-text="verse.text"></span>
                            </span>
                        </template>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container">
        <template x-for="toast in toasts" :key="toast.id">
            <div class="toast" :class="toast.type" x-transition>
                <span x-text="toast.message"></span>
            </div>
        </template>
    </div>

    <script src="/static/js/offline-storage.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
        // Show cache toast notification
        function showCacheToast(message) {
            const toast = document.getElementById('cache-toast');
            if (!toast) return;

            const msgEl = toast.querySelector('.toast-message');
            if (msgEl) msgEl.textContent = message;

            // Reset animation by cloning
            const newToast = toast.cloneNode(true);
            newToast.style.display = 'flex';
            toast.parentNode.replaceChild(newToast, toast);

            // Hide after animation completes
            setTimeout(() => {
                newToast.style.display = 'none';
            }, 2250);
        }

        // Forced offline mode - intercept all fetch requests
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            const url = typeof args[0] === 'string' ? args[0] : args[0]?.url;

            // Log API requests to help debug caching
            if (url?.includes('/api/')) {
                console.log('[Main] Fetch API:', url);
            }

            // Check if forced offline mode is enabled
            if (localStorage.getItem('forcedOffline') === 'true') {
                // Block the request and return an error that triggers offline fallback
                throw new TypeError('Network request blocked - forced offline mode');
            }
            return originalFetch.apply(this, args);
        };

        // Register service worker for offline support
        // Note: Service workers only work on localhost or HTTPS
        const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        const isSecure = location.protocol === 'https:';

        if ('serviceWorker' in navigator && (isLocalhost || isSecure)) {
            navigator.serviceWorker.register('/static/sw.js')
                .then(reg => {
                    console.log('[Main] Service worker registered:', reg.scope);
                    console.log('[Main] SW state:', reg.installing ? 'installing' : reg.waiting ? 'waiting' : reg.active ? 'active' : 'unknown');

                    // Listen for updates
                    reg.addEventListener('updatefound', () => {
                        console.log('[Main] Service worker update found');
                        const newWorker = reg.installing;
                        newWorker?.addEventListener('statechange', () => {
                            console.log('[Main] New SW state:', newWorker.state);
                        });
                    });
                })
                .catch(err => console.log('[Main] Service worker registration failed:', err));

            // Wait for service worker to be ready
            navigator.serviceWorker.ready.then(reg => {
                console.log('[Main] Service worker ready, controller:', !!navigator.serviceWorker.controller);
            });
        } else if (!isLocalhost && !isSecure) {
            console.warn('[Main] Service worker disabled: requires localhost or HTTPS. Current:', location.hostname);
        }

        // Handle messages from service worker to cache data in IndexedDB
        navigator.serviceWorker?.addEventListener('message', async (event) => {
            const { type, cacheType, data, pathname } = event.data || {};

            console.log('[Main] SW Message received:', type, cacheType, pathname);

            if (type !== 'CACHE_DATA' || !window.offlineStorage) {
                console.log('[SW Message] Skipping - type:', type, 'storage:', !!window.offlineStorage);
                return;
            }

            // Check if auto-caching is enabled
            if (localStorage.getItem('autoCacheEnabled') === 'false') {
                console.log('[SW Message] Auto-cache disabled');
                return;
            }

            try {
                // Parse reference from pathname to determine book/chapter
                const refMatch = pathname.match(/\/api\/passage\/([^/?]+)/);
                if (!refMatch) return;

                const ref = decodeURIComponent(refMatch[1]);
                const parsedRef = ref.match(/^(.+?)\s+(\d+)/);
                if (!parsedRef) return;

                const book = parsedRef[1];
                const chapter = parseInt(parsedRef[2]);

                let cached = false;
                switch (cacheType) {
                    case 'passage':
                        // Cache verses
                        if (data.verses && data.verses.length > 0) {
                            const translation = new URLSearchParams(pathname.split('?')[1]).get('translation') || 'BSB';
                            await window.offlineStorage.saveChapterVerses(translation, book, chapter, data.verses);
                            showCacheToast(`Cached ${book} ${chapter}`);
                            cached = true;
                        }
                        break;

                    case 'interlinear':
                        // Cache interlinear data
                        if (data.verses) {
                            const allWords = [];
                            for (const [verseNum, words] of Object.entries(data.verses)) {
                                for (const word of words) {
                                    allWords.push({ ...word, verse: parseInt(verseNum) });
                                }
                            }
                            if (allWords.length > 0) {
                                await window.offlineStorage.saveChapterInterlinear(book, chapter, allWords);
                                cached = true;
                            }
                        }
                        break;

                    case 'commentary':
                        // Cache commentary
                        if (data.entries && data.entries.length > 0) {
                            await window.offlineStorage.saveChapterCommentary(book, chapter, data.entries);
                            cached = true;
                        }
                        break;

                    case 'crossrefs':
                        // Cache cross-references
                        if (data.cross_references && data.cross_references.length > 0) {
                            await window.offlineStorage.saveChapterCrossRefs(book, chapter, data.cross_references);
                            cached = true;
                        }
                        break;

                    case 'lexicon':
                        // Cache lexicon entry
                        if (data.word) {
                            await window.offlineStorage.saveLexiconEntries([data.word]);
                            cached = true;
                        }
                        break;
                }

                // Refresh offline stats in the Alpine app
                if (cached) {
                    console.log('[Main] Cached data:', cacheType, book, chapter);
                    const alpineApp = document.querySelector('[x-data]')?.__x?.$data;
                    if (alpineApp && typeof alpineApp.updateOfflineStats === 'function') {
                        alpineApp.updateOfflineStats();
                    }
                }
            } catch (err) {
                console.warn('Failed to cache data in IndexedDB:', err);
            }
        });
    </script>
</body>
</html>
