<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Free, open-source Bible study platform with cross-resource linking">
    <title>BibleMVP - Free Bible Study Tool</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="bibleApp()" x-init="init()" :class="{ 'dark': darkMode }">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1 class="logo">BibleMVP</h1>
        </div>
        <div class="header-center">
            <div class="reference-input">
                <div class="autocomplete-wrapper">
                    <input
                        type="text"
                        x-model="referenceInput"
                        x-ref="referenceInput"
                        @input="updateSuggestions"
                        @keydown="handleInputKeydown"
                        @blur="hideSuggestions"
                        @focus="updateSuggestions"
                        placeholder="Enter reference (e.g., John 3:16)"
                        class="input-reference"
                        autocomplete="off"
                    >
                    <ul class="autocomplete-dropdown" x-show="showSuggestions" x-transition>
                        <template x-for="(book, index) in bookSuggestions" :key="book">
                            <li
                                @mousedown.prevent="selectSuggestion(book)"
                                :class="{ 'selected': index === selectedSuggestionIndex }"
                                class="autocomplete-item"
                                x-text="book"
                            ></li>
                        </template>
                    </ul>
                </div>
                <select x-model="translation" class="select-translation">
                    <option value="WEB">WEB</option>
                    <option value="KJV">KJV</option>
                </select>
                <button @click="loadPassage" class="btn-go">Go</button>
            </div>
        </div>
        <div class="header-right">
            <button @click="toggleDarkMode" class="btn-icon" title="Toggle dark mode (D)">
                <span x-show="!darkMode">üåô</span>
                <span x-show="darkMode">‚òÄÔ∏è</span>
            </button>
            <button @click="showHelp = true" class="btn-icon" title="Help (?)">
                ?
            </button>
            <button @click="showSearch = true" class="btn-icon" title="Search (/)">
                üîç
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Bible Text Panel -->
        <section class="panel panel-text">
            <div class="panel-header">
                <h2 x-text="currentReference || 'Select a passage'"></h2>
                <div class="reading-progress" x-show="highlightedVerses.length > 0 && verses.length > 0">
                    <div class="progress-bar" :style="'width: ' + getReadingProgress() + '%'"></div>
                    <span class="progress-text" x-text="highlightedVerses[0] + '/' + verses.length"></span>
                </div>
                <div class="nav-buttons" x-show="currentReference">
                    <button @click="previousChapter" class="btn-nav" title="Previous chapter">‚Üê Ch</button>
                    <button @click="previousVerse" class="btn-nav" title="Previous verse" :disabled="!canGoPrevVerse()">‚Üê V</button>
                    <button @click="nextVerse" class="btn-nav" title="Next verse" :disabled="!canGoNextVerse()">V ‚Üí</button>
                    <button @click="nextChapter" class="btn-nav" title="Next chapter">Ch ‚Üí</button>
                </div>
            </div>
            <div class="panel-body">
                <div x-show="loading" class="loading">Loading...</div>
                <div x-show="error" class="error" x-text="error"></div>

                <!-- Book selector when no passage loaded -->
                <div x-show="!loading && !error && verses.length === 0" class="book-selector">
                    <p class="book-selector-intro">Select a book to begin reading:</p>
                    <div class="book-section">
                        <h3>Old Testament</h3>
                        <div class="book-grid">
                            <template x-for="book in otBooks" :key="book">
                                <button @click="loadReference(book + ' 1')" class="book-btn" x-text="book"></button>
                            </template>
                        </div>
                    </div>
                    <div class="book-section">
                        <h3>New Testament</h3>
                        <div class="book-grid">
                            <template x-for="book in ntBooks" :key="book">
                                <button @click="loadReference(book + ' 1')" class="book-btn" x-text="book"></button>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Interlinear toggle for Genesis/Matthew -->
                <div x-show="!loading && !error && verses.length > 0 && (currentBook === 'Genesis' || currentBook === 'Matthew')" class="interlinear-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" x-model="showInterlinear" class="toggle-checkbox">
                        <span class="toggle-text">Show <span x-text="currentBook === 'Genesis' ? 'Hebrew' : 'Greek'"></span></span>
                    </label>
                </div>

                <div x-show="!loading && !error && verses.length > 0" class="verses">
                    <template x-for="verse in verses" :key="verse.id">
                        <div
                            class="verse-box"
                            :id="'verse-' + verse.verse"
                            :class="{ 'verse-highlighted': isVerseHighlighted(verse.verse), 'has-interlinear': showInterlinear && hasInterlinear(verse.verse) }"
                            @click="handleVerseBoxClick($event, verse.verse)"
                        >
                            <sup class="verse-num" x-text="verse.verse"></sup>
                            <span
                                class="verse-text"
                                x-html="formatVerseText(verse.text)"
                            ></span>
                            <!-- Interlinear display -->
                            <div x-show="showInterlinear && hasInterlinear(verse.verse)" class="interlinear-row" :class="getInterlinearLanguage(verse.verse)">
                                <template x-for="word in getInterlinearWords(verse.verse)" :key="word.position">
                                    <span
                                        class="interlinear-word"
                                        @click.stop="handleInterlinearWordClick(word)"
                                        :class="{ 'has-strong': word.strong_number }"
                                        :title="word.transliteration + (word.strong_number ? ' (' + word.strong_number + ')' : '')"
                                    >
                                        <span class="original-text" x-text="word.original_text"></span>
                                        <span class="word-gloss" x-text="word.translation || '‚Äî'"></span>
                                    </span>
                                </template>
                            </div>
                            <button
                                class="btn-copy"
                                @click.stop="copyVerse(verse)"
                                :title="copyFeedback === verse.verse ? 'Copied!' : 'Copy verse'"
                            >
                                <span x-show="copyFeedback !== verse.verse">üìã</span>
                                <span x-show="copyFeedback === verse.verse">‚úì</span>
                            </button>
                        </div>
                    </template>
                </div>
            </div>
        </section>

        <!-- Resources Panel -->
        <section class="panel panel-resources" :class="{ 'expanded': resourcesPanelExpanded }">
            <div class="panel-tabs">
                <button
                    class="tab-drag-handle"
                    @click="resourcesPanelExpanded = !resourcesPanelExpanded"
                    aria-label="Toggle resources panel"
                >
                    <span class="drag-indicator"></span>
                </button>
                <button
                    class="btn-close-panel"
                    @click="resourcesPanelExpanded = false"
                    x-show="resourcesPanelExpanded"
                    aria-label="Close panel"
                >√ó</button>
                <button
                    @click="activeTab = 'commentary'; resourcesPanelExpanded = true"
                    :class="{ 'active': activeTab === 'commentary' }"
                    class="tab-btn"
                >Commentary</button>
                <button
                    @click="activeTab = 'notes'; resourcesPanelExpanded = true"
                    :class="{ 'active': activeTab === 'notes' }"
                    class="tab-btn"
                >Notes</button>
                <button
                    @click="activeTab = 'crossrefs'; resourcesPanelExpanded = true"
                    :class="{ 'active': activeTab === 'crossrefs' }"
                    class="tab-btn"
                    x-text="'Cross-Refs' + (crossRefs.length ? ' (' + crossRefs.length + ')' : '')"
                >Cross-Refs</button>
            </div>
            <div class="panel-body">
                <!-- Commentary Tab -->
                <div x-show="activeTab === 'commentary'" class="tab-content">
                    <template x-if="!currentReference">
                        <p class="empty-state">Select a passage to see commentary.</p>
                    </template>
                    <template x-if="commentary.length === 0 && currentReference">
                        <p class="empty-state">No commentary available for this passage.</p>
                    </template>
                    <template x-for="entry in commentary" :key="entry.source">
                        <div class="commentary-entry">
                            <h3 class="commentary-source" x-text="entry.source"></h3>
                            <div class="commentary-content" x-html="entry.content"></div>
                        </div>
                    </template>
                </div>

                <!-- Notes Tab -->
                <div x-show="activeTab === 'notes'" class="tab-content">
                    <template x-if="!currentBook">
                        <p class="empty-state">Select a passage to add notes.</p>
                    </template>
                    <template x-if="currentBook">
                        <div class="notes-editor">
                            <div class="note-reference-row">
                                <span class="note-for">Note for:</span>
                                <span class="note-ref" x-text="currentBook + ' ' + currentChapter + ':' + getNoteStartVerse()"></span>
                                <template x-if="showNoteRange">
                                    <span class="note-range-to">
                                        -<input
                                            type="number"
                                            x-model="noteEndVerse"
                                            :min="getNoteStartVerse()"
                                            :max="verses.length"
                                            class="input-end-verse"
                                            placeholder="end"
                                        >
                                    </span>
                                </template>
                                <button
                                    @click="showNoteRange = !showNoteRange; if(!showNoteRange) noteEndVerse = null"
                                    class="btn-range-toggle"
                                    :title="showNoteRange ? 'Single verse' : 'Add verse range'"
                                    x-text="showNoteRange ? '‚àí' : '+'"
                                ></button>
                            </div>
                            <textarea
                                x-model="currentNote"
                                placeholder="Add your notes for this passage..."
                                class="note-textarea"
                            ></textarea>
                            <button @click="saveNote" class="btn-save" :disabled="!currentNote.trim()">
                                Save Note
                            </button>
                        </div>
                    </template>
                    <div class="saved-notes">
                        <template x-for="note in getRelevantNotes()" :key="note.id">
                            <div class="note-card">
                                <div class="note-meta">
                                    <span x-text="formatNoteReference(note)"></span>
                                    <span x-text="formatDate(note.created_at)"></span>
                                    <button @click="deleteNote(note.id)" class="btn-delete-note" title="Delete note">√ó</button>
                                </div>
                                <div class="note-content" x-text="note.content"></div>
                            </div>
                        </template>
                        <template x-if="getRelevantNotes().length === 0 && currentBook">
                            <p class="empty-state">No notes for this verse yet.</p>
                        </template>
                    </div>
                </div>

                <!-- Cross-References Tab -->
                <div x-show="activeTab === 'crossrefs'" class="tab-content">
                    <template x-if="!currentReference">
                        <p class="empty-state">Select a verse to see cross-references.</p>
                    </template>
                    <template x-if="crossRefs.length === 0 && currentReference">
                        <p class="empty-state">No cross-references found for this verse.</p>
                    </template>
                    <ul class="crossref-list">
                        <template x-for="ref in crossRefs" :key="ref.target_book + ref.target_chapter + ref.target_verse">
                            <li class="crossref-item"
                                @mouseenter="previewVerse(ref.target_book + ' ' + ref.target_chapter + ':' + ref.target_verse, $event)"
                                @mouseleave="hidePreview()"
                            >
                                <a
                                    href="#"
                                    @click.prevent="loadReference(ref.target_book + ' ' + ref.target_chapter + ':' + ref.target_verse)"
                                    x-text="ref.target_book + ' ' + ref.target_chapter + ':' + ref.target_verse"
                                ></a>
                            </li>
                        </template>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Word Details Panel (shows on word click) -->
        <aside class="panel panel-word" x-show="selectedWord" x-transition>
            <div class="panel-header">
                <h2>Word Details</h2>
                <button @click="selectedWord = null" class="btn-close">√ó</button>
            </div>
            <div class="panel-body" x-show="selectedWord">
                <div class="word-header">
                    <span class="word-original" :class="selectedWord?.language" x-text="selectedWord?.original || selectedWord?.text"></span>
                    <span class="word-transliteration" x-text="selectedWord?.transliteration || '‚Äî'"></span>
                </div>
                <div class="word-strongs" x-show="selectedWord?.strong_number">
                    <span class="strong-badge" :class="selectedWord?.language" x-text="selectedWord?.strong_number"></span>
                    <span class="word-lang-label" x-text="selectedWord?.language === 'hebrew' ? 'Hebrew' : selectedWord?.language === 'greek' ? 'Greek' : ''"></span>
                </div>
                <div class="word-pronunciation" x-show="selectedWord?.pronunciation">
                    <em x-text="selectedWord?.pronunciation"></em>
                </div>
                <div class="word-definition">
                    <strong>Definition:</strong>
                    <p x-text="selectedWord?.definition || 'No definition available'"></p>
                </div>
                <div class="word-extended" x-show="selectedWord?.extended_definition">
                    <strong>KJV Usage:</strong>
                    <p x-text="selectedWord?.extended_definition"></p>
                </div>
                <div class="word-derivation" x-show="selectedWord?.derivation">
                    <strong>Derivation:</strong>
                    <p x-text="selectedWord?.derivation"></p>
                </div>
                <div class="word-occurrences" x-show="selectedWord?.count > 0">
                    <h4>Appears <span x-text="selectedWord?.count"></span> times:</h4>
                    <ul class="occurrence-list">
                        <template x-for="occ in (selectedWord?.occurrences || []).slice(0, 10)" :key="occ.book + occ.chapter + occ.verse + occ.position">
                            <li>
                                <a
                                    href="#"
                                    @click.prevent="loadReference(occ.book + ' ' + occ.chapter + ':' + occ.verse)"
                                    x-text="occ.book + ' ' + occ.chapter + ':' + occ.verse"
                                ></a>
                            </li>
                        </template>
                        <li x-show="selectedWord?.count > 10" class="more-occurrences">
                            ...and <span x-text="selectedWord?.count - 10"></span> more
                        </li>
                    </ul>
                </div>
            </div>
        </aside>
    </main>

    <!-- Search Modal -->
    <div class="modal-overlay" x-show="showSearch" x-transition @click.self="showSearch = false">
        <div class="modal search-modal">
            <div class="modal-header">
                <h2>Search</h2>
                <button @click="showSearch = false" class="btn-close">√ó</button>
            </div>
            <div class="modal-body">
                <div class="search-input-group">
                    <input
                        type="text"
                        x-model="searchQuery"
                        @keydown.enter="performSearch"
                        placeholder="Search Bible, notes, commentary..."
                        class="input-search"
                        x-ref="searchInput"
                    >
                    <select x-model="searchScope" class="select-scope">
                        <option value="all">All</option>
                        <option value="bible">Bible Text</option>
                        <option :value="'book:' + currentBook" x-show="currentBook" x-text="'In ' + currentBook"></option>
                        <option value="commentary">Commentary</option>
                        <option value="notes">Notes</option>
                    </select>
                    <button @click="performSearch" class="btn-search">Search</button>
                </div>
                <div class="search-results">
                    <template x-for="result in searchResults" :key="result.type + result.book + result.chapter + result.verse">
                        <div class="search-result" @click="goToSearchResult(result)">
                            <div class="result-type" x-text="result.type"></div>
                            <div class="result-ref" x-text="result.book + ' ' + result.chapter + ':' + result.verse"></div>
                            <div class="result-snippet" x-html="result.snippet"></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" x-show="showHelp" x-transition @click.self="showHelp = false">
        <div class="modal help-modal">
            <div class="modal-header">
                <h2>Quick Guide</h2>
                <button @click="showHelp = false" class="btn-close">√ó</button>
            </div>
            <div class="modal-body">
                <section class="help-section">
                    <h3>Getting Started</h3>
                    <p>Type a reference like <strong>John 3:16</strong> or <strong>Rom 8</strong> in the search bar and press Go. Click any verse to highlight it and see cross-references.</p>
                </section>

                <section class="help-section">
                    <h3>Keyboard Shortcuts</h3>
                    <div class="shortcuts-grid">
                        <div class="shortcut">
                            <kbd>‚Üê</kbd> <kbd>‚Üí</kbd>
                            <span>Previous/Next chapter</span>
                        </div>
                        <div class="shortcut">
                            <kbd>‚Üë</kbd> <kbd>‚Üì</kbd>
                            <span>Previous/Next verse</span>
                        </div>
                        <div class="shortcut">
                            <kbd>/</kbd>
                            <span>Open search</span>
                        </div>
                        <div class="shortcut">
                            <kbd>G</kbd>
                            <span>Go to reference</span>
                        </div>
                        <div class="shortcut">
                            <kbd>D</kbd>
                            <span>Toggle dark mode</span>
                        </div>
                        <div class="shortcut">
                            <kbd>C</kbd>
                            <span>Copy current verse</span>
                        </div>
                        <div class="shortcut">
                            <kbd>?</kbd>
                            <span>Show this help</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Esc</kbd>
                            <span>Close panels/modals</span>
                        </div>
                    </div>
                </section>

                <section class="help-section">
                    <h3>Features</h3>
                    <ul class="help-features">
                        <li><strong>Commentary</strong> - Matthew Henry's commentary on the right panel</li>
                        <li><strong>Cross-refs</strong> - Related verses that reference the same themes</li>
                        <li><strong>Notes</strong> - Save your own study notes (stored locally)</li>
                        <li><strong>Copy</strong> - Click the clipboard icon on any verse</li>
                        <li><strong>Share</strong> - URLs update as you navigate for easy sharing</li>
                    </ul>
                </section>
            </div>
        </div>
    </div>

    <!-- Verse Preview Tooltip -->
    <div
        x-show="versePreview.show"
        x-transition
        class="verse-preview-tooltip"
        :style="'top: ' + versePreview.y + 'px; left: ' + versePreview.x + 'px;'"
    >
        <div class="preview-ref" x-text="versePreview.reference"></div>
        <div class="preview-text" x-text="versePreview.text"></div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>
